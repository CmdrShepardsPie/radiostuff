"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_helpers_1 = require("@helpers/fs-helpers");
const helpers_1 = require("@helpers/helpers");
const log_helpers_1 = require("@helpers/log-helpers");
const axios_1 = __importDefault(require("axios"));
const chalk_1 = __importDefault(require("chalk"));
const jsdom_1 = require("jsdom");
const helper_1 = require("./helper");
const { log, write } = log_helpers_1.createOut('Scraper');
// const write = createWrite("Scraper");
class Scraper {
    constructor(location, distance) {
        this.location = location;
        this.distance = distance;
        this.data = [];
        log(chalk_1.default.green('New Scraper'), location, distance);
        this.url = `https://www.repeaterbook.com/repeaters/prox_result.php?city=${encodeURIComponent(location.toString())}&distance=${distance}&Dunit=m&band1=%25&band2=&freq=&call=&features=&status_id=%25&use=%25&order=%60state_id%60%2C+%60loc%60%2C+%60call%60+ASC`;
    }
    async process() {
        log(chalk_1.default.green('Process'));
        const parts = this.location.toString().split(`,`);
        const baseKey = `${(parts[1] || '.').trim()}/${parts[0].trim()}.html`;
        const page = await this.getUrl(this.url, baseKey);
        const dom = new jsdom_1.JSDOM(page);
        await this.getRepeaterList(dom.window.document);
        return this.data;
    }
    async getRepeaterList(document) {
        log(chalk_1.default.green('Get Repeater List'));
        const table = document.querySelector('table.w3-table.w3-striped.w3-responsive');
        if (table) {
            const rows = [...table.querySelectorAll('tbody > tr')];
            const headerRow = rows.shift();
            if (headerRow) {
                const headerCells = [...headerRow.querySelectorAll('th')];
                const headers = headerCells.map((th) => helper_1.getText(th));
                for (const row of rows) {
                    const data = {};
                    const cells = [...row.querySelectorAll('td')];
                    cells.forEach((td, index) => data[headers[index]] = helper_1.getTextOrNumber(td));
                    const link = cells[0].querySelector('a');
                    if (link) {
                        write('^');
                        Object.assign(data, await this.getRepeaterDetails(link.href));
                        write('_');
                    }
                    this.data.push(data);
                }
            }
        }
    }
    async getRepeaterDetails(href) {
        const urlParams = href.split('?')[1];
        const keyParts = urlParams.match(/state_id=(\d+)&ID=(\d+)/) || [];
        const key = `${keyParts[1]}/${keyParts[2]}.html`;
        const page = await this.getUrl(`https://www.repeaterbook.com/repeaters/${href}`, key);
        const dom = new jsdom_1.JSDOM(page);
        const data = {};
        data.state_id = keyParts[1];
        data.ID = keyParts[2];
        const menus = [...dom.window.document.querySelectorAll('#cssmenu a')];
        const locationRegex = /(-?\d*\.?\d*)\+(-?\d*\.?\d*)/i;
        for (const menu of menus) {
            const locationMatch = menu.href.match(locationRegex);
            if (locationMatch) {
                const lat = helper_1.getNumber(locationMatch[1]);
                const long = helper_1.getNumber(locationMatch[2]);
                if (!isNaN(lat)) {
                    data.Latitude = lat;
                }
                if (!isNaN(long)) {
                    data.Longitude = long;
                }
                break;
            }
        }
        const table = dom.window.document.querySelector('table.w3-table.w3-responsive');
        if (table) {
            const rows = [...table.querySelectorAll('tbody > tr')];
            for (const row of rows) {
                const cells = [...row.querySelectorAll('td')];
                const title = helper_1.getText(cells[0]);
                const value = helper_1.getTextOrNumber(cells[1]);
                const dataKey = title.split(':')[0].trim();
                const dataVal = title.split(':')[1];
                let updated;
                if (dataVal) {
                    const date = dataVal.match(/(\d{4}-\d{2}-\d{2})/);
                    if (date && date[1]) {
                        updated = date[1];
                    }
                }
                data[dataKey] = updated || value;
            }
        }
        return data;
    }
    async getCache(key) {
        const file = `data/repeaters/_cache/${key}`;
        if (await fs_helpers_1.dirExists(file)) {
            return (await fs_helpers_1.readFileAsync(file)).toString();
        }
    }
    async setCache(key, value) {
        const file = `data/repeaters/_cache/${key}`;
        await fs_helpers_1.makeDirs(file);
        return fs_helpers_1.writeFileAsync(file, value);
    }
    async getUrl(url, cacheKey) {
        // log(chalk.green("Get URL"), url, cacheKey);
        const cache = await this.getCache(cacheKey || url);
        if (cache) {
            // log(chalk.yellow("Cached"), url, cacheKey);
            write('<');
            return cache;
        }
        else {
            // Slow down the requests a little bit so we're not hammering the server or triggering any anti-bot or DDoS protections
            const waitTime = (5000 + (Math.random() * 10000));
            await helpers_1.wait(waitTime);
            // log(chalk.yellow("Get"), url);
            const request = await axios_1.default.get(url);
            // log(chalk.green("Got"), url);
            write('>');
            const data = request.data;
            await this.setCache(cacheKey || url, data);
            return data;
        }
    }
}
exports.default = Scraper;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyYXBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zY3JpcHRzL21vZHVsZXMvc2NyYXBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLG9EQUF5RjtBQUN6Riw4Q0FBd0M7QUFDeEMsc0RBQWlEO0FBRWpELGtEQUE2QztBQUM3QyxrREFBMEI7QUFDMUIsaUNBQThCO0FBQzlCLHFDQUErRDtBQUUvRCxNQUFNLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFxRSx1QkFBUyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzlHLHdDQUF3QztBQUV4QyxNQUFxQixPQUFPO0lBSTFCLFlBQW9CLFFBQXlCLEVBQVUsUUFBZ0I7UUFBbkQsYUFBUSxHQUFSLFFBQVEsQ0FBaUI7UUFBVSxhQUFRLEdBQVIsUUFBUSxDQUFRO1FBSC9ELFNBQUksR0FBbUIsRUFBRSxDQUFDO1FBSWhDLEdBQUcsQ0FBQyxlQUFLLENBQUMsS0FBSyxDQUFDLGFBQWEsQ0FBQyxFQUFFLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsR0FBRyxHQUFHLCtEQUErRCxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUMsYUFBYSxRQUFRLDJIQUEySCxDQUFDO0lBQ3BRLENBQUM7SUFFTSxLQUFLLENBQUMsT0FBTztRQUNsQixHQUFHLENBQUMsZUFBSyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBRTVCLE1BQU0sS0FBSyxHQUFhLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzVELE1BQU0sT0FBTyxHQUFXLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxPQUFPLENBQUM7UUFDOUUs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LENBQUMsQ0FBQztRQUNyQixPQUFPLDJCQUFjLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFTyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQVcsRUFBRSxRQUFpQjtRQUNqRCw4Q0FBOEM7UUFFOUMsTUFBTSxLQUFLLEdBQXVCLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLElBQUksR0FBRyxDQUFDLENBQUM7UUFDdkUsSUFBSSxLQUFLLEVBQUU7WUFDVCw4Q0FBOEM7WUFDOUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ1gsT0FBTyxLQUFLLENBQUM7U0FDZDthQUFNO1lBQ0wsdUhBQXVIO1lBQ3ZILE1BQU0sUUFBUSxHQUFXLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFFMUQsTUFBTSxjQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDckIsaUNBQWlDO1lBQ2pDLE1BQU0sT0FBTyxHQUEwQixNQUFNLGVBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDNUQsZ0NBQWdDO1lBQ2hDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVYLE1BQU0sSUFBSSxHQUFXLE9BQU8sQ0FBQyxJQUFJLENBQUM7WUFDbEMsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsSUFBSSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDM0MsT0FBTyxJQUFJLENBQUM7U0FDYjtJQUNILENBQUM7Q0FDRjtBQWpJRCwwQkFpSUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkaXJFeGlzdHMsIG1ha2VEaXJzLCByZWFkRmlsZUFzeW5jLCB3cml0ZUZpbGVBc3luYyB9IGZyb20gJ0BoZWxwZXJzL2ZzLWhlbHBlcnMnO1xyXG5pbXBvcnQgeyB3YWl0IH0gZnJvbSAnQGhlbHBlcnMvaGVscGVycyc7XHJcbmltcG9ydCB7IGNyZWF0ZU91dCB9IGZyb20gJ0BoZWxwZXJzL2xvZy1oZWxwZXJzJztcclxuaW1wb3J0IHsgSVJlcGVhdGVyUmF3IH0gZnJvbSAnQGludGVyZmFjZXMvaS1yZXBlYXRlci1yYXcnO1xyXG5pbXBvcnQgQXhpb3MsIHsgQXhpb3NSZXNwb25zZSB9IGZyb20gJ2F4aW9zJztcclxuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcclxuaW1wb3J0IHsgSlNET00gfSBmcm9tICdqc2RvbSc7XHJcbmltcG9ydCB7IGdldE51bWJlciwgZ2V0VGV4dCwgZ2V0VGV4dE9yTnVtYmVyIH0gZnJvbSAnLi9oZWxwZXInO1xyXG5cclxuY29uc3QgeyBsb2csIHdyaXRlIH06IHsgbG9nOiAoLi4ubXNnOiBhbnlbXSkgPT4gdm9pZDsgd3JpdGU6ICguLi5tc2c6IGFueVtdKSA9PiB2b2lkIH0gPSBjcmVhdGVPdXQoJ1NjcmFwZXInKTtcclxuLy8gY29uc3Qgd3JpdGUgPSBjcmVhdGVXcml0ZShcIlNjcmFwZXJcIik7XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTY3JhcGVyIHtcclxuICBwcml2YXRlIGRhdGE6IElSZXBlYXRlclJhd1tdID0gW107XHJcbiAgcHJpdmF0ZSByZWFkb25seSB1cmw6IHN0cmluZztcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBsb2NhdGlvbjogc3RyaW5nIHwgbnVtYmVyLCBwcml2YXRlIGRpc3RhbmNlOiBudW1iZXIpIHtcclxuICAgIGxvZyhjaGFsay5ncmVlbignTmV3IFNjcmFwZXInKSwgbG9jYXRpb24sIGRpc3RhbmNlKTtcclxuICAgIHRoaXMudXJsID0gYGh0dHBzOi8vd3d3LnJlcGVhdGVyYm9vay5jb20vcmVwZWF0ZXJzL3Byb3hfcmVzdWx0LnBocD9jaXR5PSR7ZW5jb2RlVVJJQ29tcG9uZW50KGxvY2F0aW9uLnRvU3RyaW5nKCkpfSZkaXN0YW5jZT0ke2Rpc3RhbmNlfSZEdW5pdD1tJmJhbmQxPSUyNSZiYW5kMj0mZnJlcT0mY2FsbD0mZmVhdHVyZXM9JnN0YXR1c19pZD0lMjUmdXNlPSUyNSZvcmRlcj0lNjBzdGF0ZV9pZCU2MCUyQyslNjBsb2MlNjAlMkMrJTYwY2FsbCU2MCtBU0NgO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIHByb2Nlc3MoKTogUHJvbWlzZTxJUmVwZWF0ZXJSYXdbXT4ge1xyXG4gICAgbG9nKGNoYWxrLmdyZWVuKCdQcm9jZXNzJykpO1xyXG5cclxuICAgIGNvbnN0IHBhcnRzOiBzdHJpbmdbXSA9IHRoaXMubG9jYXRpb24udG9TdHJpbmcoKS5zcGxpdChgLGApO1xyXG4gICAgY29uc3QgYmFzZUtleTogc3RyaW5nID0gYCR7KHBhcnRzWzFdIHx8ICcuJykudHJpbSgpfS8ke3BhcnRzWzBdLnRyaW0oKX0uaHRtbGA7XHJcbiAgICBjb25zdCBwYWdlOiBzdHJpbmcgPSBhd2FpdCB0aGlzLmdldFVybCh0aGlzLnVybCwgYmFzZUtleSk7XHJcbiAgICBjb25zdCBkb206IEpTRE9NID0gbmV3IEpTRE9NKHBhZ2UpO1xyXG4gICAgYXdhaXQgdGhpcy5nZXRSZXBlYXRlckxpc3QoZG9tLndpbmRvdy5kb2N1bWVudCk7XHJcbiAgICByZXR1cm4gdGhpcy5kYXRhO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyBnZXRSZXBlYXRlckxpc3QoZG9jdW1lbnQ6IERvY3VtZW50KTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBsb2coY2hhbGsuZ3JlZW4oJ0dldCBSZXBlYXRlciBMaXN0JykpO1xyXG5cclxuICAgIGNvbnN0IHRhYmxlOiBIVE1MVGFibGVFbGVtZW50IHwgbnVsbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ3RhYmxlLnczLXRhYmxlLnczLXN0cmlwZWQudzMtcmVzcG9uc2l2ZScpO1xyXG4gICAgaWYgKHRhYmxlKSB7XHJcbiAgICAgIGNvbnN0IHJvd3M6IEhUTUxUYWJsZVJvd0VsZW1lbnRbXSA9IFsuLi50YWJsZS5xdWVyeVNlbGVjdG9yQWxsPEhUTUxUYWJsZVJvd0VsZW1lbnQ+KCd0Ym9keSA+IHRyJyldO1xyXG4gICAgICBjb25zdCBoZWFkZXJSb3c6IGFueSB8IHVuZGVmaW5lZCA9IHJvd3Muc2hpZnQoKTtcclxuICAgICAgaWYgKGhlYWRlclJvdykge1xyXG4gICAgICAgIGNvbnN0IGhlYWRlckNlbGxzOiBIVE1MVGFibGVIZWFkZXJDZWxsRWxlbWVudFtdID0gWy4uLmhlYWRlclJvdy5xdWVyeVNlbGVjdG9yQWxsKCd0aCcpXTtcclxuICAgICAgICBjb25zdCBoZWFkZXJzOiBzdHJpbmdbXSA9IGhlYWRlckNlbGxzLm1hcCgodGg6IEhUTUxUYWJsZUhlYWRlckNlbGxFbGVtZW50KSA9PiBnZXRUZXh0KHRoKSk7XHJcbiAgICAgICAgZm9yIChjb25zdCByb3cgb2Ygcm93cykge1xyXG4gICAgICAgICAgY29uc3QgZGF0YTogeyBbIGtleTogc3RyaW5nIF06IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCB9ID0ge307XHJcbiAgICAgICAgICBjb25zdCBjZWxsczogSFRNTFRhYmxlRGF0YUNlbGxFbGVtZW50W10gPSBbLi4ucm93LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RkJyldO1xyXG4gICAgICAgICAgY2VsbHMuZm9yRWFjaCgodGQ6IEhUTUxUYWJsZURhdGFDZWxsRWxlbWVudCwgaW5kZXg6IG51bWJlcikgPT4gZGF0YVtoZWFkZXJzW2luZGV4XV0gPSBnZXRUZXh0T3JOdW1iZXIodGQpKTtcclxuICAgICAgICAgIGNvbnN0IGxpbms6IEhUTUxBbmNob3JFbGVtZW50IHwgbnVsbCA9IGNlbGxzWzBdLnF1ZXJ5U2VsZWN0b3IoJ2EnKTtcclxuICAgICAgICAgIGlmIChsaW5rKSB7XHJcbiAgICAgICAgICAgIHdyaXRlKCdeJyk7XHJcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oZGF0YSwgYXdhaXQgdGhpcy5nZXRSZXBlYXRlckRldGFpbHMobGluay5ocmVmKSk7XHJcbiAgICAgICAgICAgIHdyaXRlKCdfJyk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICB0aGlzLmRhdGEucHVzaChkYXRhIGFzIGFueSBhcyBJUmVwZWF0ZXJSYXcpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyBnZXRSZXBlYXRlckRldGFpbHMoaHJlZjogc3RyaW5nKTogUHJvbWlzZTxJUmVwZWF0ZXJSYXc+IHtcclxuICAgIGNvbnN0IHVybFBhcmFtczogc3RyaW5nID0gaHJlZi5zcGxpdCgnPycpWzFdO1xyXG4gICAgY29uc3Qga2V5UGFydHM6IFJlZ0V4cE1hdGNoQXJyYXkgPSB1cmxQYXJhbXMubWF0Y2goL3N0YXRlX2lkPShcXGQrKSZJRD0oXFxkKykvKSB8fCBbXTtcclxuICAgIGNvbnN0IGtleTogc3RyaW5nID0gYCR7a2V5UGFydHNbMV19LyR7a2V5UGFydHNbMl19Lmh0bWxgO1xyXG4gICAgY29uc3QgcGFnZTogc3RyaW5nID0gYXdhaXQgdGhpcy5nZXRVcmwoYGh0dHBzOi8vd3d3LnJlcGVhdGVyYm9vay5jb20vcmVwZWF0ZXJzLyR7aHJlZn1gLCBrZXkpO1xyXG4gICAgY29uc3QgZG9tOiBKU0RPTSA9IG5ldyBKU0RPTShwYWdlKTtcclxuICAgIGNvbnN0IGRhdGE6IHsgWyBrZXk6IHN0cmluZyBdOiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQgfSA9IHt9O1xyXG4gICAgZGF0YS5zdGF0ZV9pZCA9IGtleVBhcnRzWzFdO1xyXG4gICAgZGF0YS5JRCA9IGtleVBhcnRzWzJdO1xyXG4gICAgY29uc3QgbWVudXM6IEhUTUxBbmNob3JFbGVtZW50W10gPSBbLi4uZG9tLndpbmRvdy5kb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsPEhUTUxBbmNob3JFbGVtZW50PignI2Nzc21lbnUgYScpXTtcclxuICAgIGNvbnN0IGxvY2F0aW9uUmVnZXg6IFJlZ0V4cCA9IC8oLT9cXGQqXFwuP1xcZCopXFwrKC0/XFxkKlxcLj9cXGQqKS9pO1xyXG4gICAgZm9yIChjb25zdCBtZW51IG9mIG1lbnVzKSB7XHJcbiAgICAgIGNvbnN0IGxvY2F0aW9uTWF0Y2g6IFJlZ0V4cE1hdGNoQXJyYXkgfCBudWxsID0gbWVudS5ocmVmLm1hdGNoKGxvY2F0aW9uUmVnZXgpO1xyXG4gICAgICBpZiAobG9jYXRpb25NYXRjaCkge1xyXG4gICAgICAgIGNvbnN0IGxhdDogbnVtYmVyID0gZ2V0TnVtYmVyKGxvY2F0aW9uTWF0Y2hbMV0pO1xyXG4gICAgICAgIGNvbnN0IGxvbmc6IG51bWJlciA9IGdldE51bWJlcihsb2NhdGlvbk1hdGNoWzJdKTtcclxuICAgICAgICBpZiAoIWlzTmFOKGxhdCkpIHtcclxuICAgICAgICAgIGRhdGEuTGF0aXR1ZGUgPSBsYXQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghaXNOYU4obG9uZykpIHtcclxuICAgICAgICAgIGRhdGEuTG9uZ2l0dWRlID0gbG9uZztcclxuICAgICAgICB9XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IHRhYmxlOiBFbGVtZW50IHwgbnVsbCA9IGRvbS53aW5kb3cuZG9jdW1lbnQucXVlcnlTZWxlY3RvcigndGFibGUudzMtdGFibGUudzMtcmVzcG9uc2l2ZScpO1xyXG4gICAgaWYgKHRhYmxlKSB7XHJcbiAgICAgIGNvbnN0IHJvd3M6IEhUTUxUYWJsZVJvd0VsZW1lbnRbXSA9IFsuLi50YWJsZS5xdWVyeVNlbGVjdG9yQWxsPEhUTUxUYWJsZVJvd0VsZW1lbnQ+KCd0Ym9keSA+IHRyJyldO1xyXG4gICAgICBmb3IgKGNvbnN0IHJvdyBvZiByb3dzKSB7XHJcbiAgICAgICAgY29uc3QgY2VsbHM6IEhUTUxUYWJsZURhdGFDZWxsRWxlbWVudFtdID0gWy4uLnJvdy5xdWVyeVNlbGVjdG9yQWxsKCd0ZCcpXTtcclxuICAgICAgICBjb25zdCB0aXRsZTogc3RyaW5nID0gZ2V0VGV4dChjZWxsc1swXSk7XHJcbiAgICAgICAgY29uc3QgdmFsdWU6IG51bWJlciB8IHN0cmluZyA9IGdldFRleHRPck51bWJlcihjZWxsc1sxXSk7XHJcbiAgICAgICAgY29uc3QgZGF0YUtleTogc3RyaW5nID0gdGl0bGUuc3BsaXQoJzonKVswXS50cmltKCk7XHJcbiAgICAgICAgY29uc3QgZGF0YVZhbDogc3RyaW5nID0gdGl0bGUuc3BsaXQoJzonKVsxXTtcclxuICAgICAgICBsZXQgdXBkYXRlZDogbnVtYmVyIHwgc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmIChkYXRhVmFsKSB7XHJcbiAgICAgICAgICBjb25zdCBkYXRlOiBSZWdFeHBNYXRjaEFycmF5IHwgbnVsbCA9IGRhdGFWYWwubWF0Y2goLyhcXGR7NH0tXFxkezJ9LVxcZHsyfSkvKTtcclxuICAgICAgICAgIGlmIChkYXRlICYmIGRhdGVbMV0pIHtcclxuICAgICAgICAgICAgdXBkYXRlZCA9IGRhdGVbMV07XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGRhdGFbZGF0YUtleV0gPSB1cGRhdGVkIHx8IHZhbHVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gZGF0YSBhcyBhbnkgYXMgSVJlcGVhdGVyUmF3O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyBnZXRDYWNoZShrZXk6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPiB7XHJcbiAgICBjb25zdCBmaWxlOiBzdHJpbmcgPSBgZGF0YS9yZXBlYXRlcnMvX2NhY2hlLyR7a2V5fWA7XHJcbiAgICBpZiAoYXdhaXQgZGlyRXhpc3RzKGZpbGUpKSB7XHJcbiAgICAgIHJldHVybiAoYXdhaXQgcmVhZEZpbGVBc3luYyhmaWxlKSkudG9TdHJpbmcoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgc2V0Q2FjaGUoa2V5OiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGNvbnN0IGZpbGU6IHN0cmluZyA9IGBkYXRhL3JlcGVhdGVycy9fY2FjaGUvJHtrZXl9YDtcclxuICAgIGF3YWl0IG1ha2VEaXJzKGZpbGUpO1xyXG4gICAgcmV0dXJuIHdyaXRlRmlsZUFzeW5jKGZpbGUsIHZhbHVlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgZ2V0VXJsKHVybDogc3RyaW5nLCBjYWNoZUtleT86IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICAvLyBsb2coY2hhbGsuZ3JlZW4oXCJHZXQgVVJMXCIpLCB1cmwsIGNhY2hlS2V5KTtcclxuXHJcbiAgICBjb25zdCBjYWNoZTogc3RyaW5nIHwgdW5kZWZpbmVkID0gYXdhaXQgdGhpcy5nZXRDYWNoZShjYWNoZUtleSB8fCB1cmwpO1xyXG4gICAgaWYgKGNhY2hlKSB7XHJcbiAgICAgIC8vIGxvZyhjaGFsay55ZWxsb3coXCJDYWNoZWRcIiksIHVybCwgY2FjaGVLZXkpO1xyXG4gICAgICB3cml0ZSgnPCcpO1xyXG4gICAgICByZXR1cm4gY2FjaGU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBTbG93IGRvd24gdGhlIHJlcXVlc3RzIGEgbGl0dGxlIGJpdCBzbyB3ZSdyZSBub3QgaGFtbWVyaW5nIHRoZSBzZXJ2ZXIgb3IgdHJpZ2dlcmluZyBhbnkgYW50aS1ib3Qgb3IgRERvUyBwcm90ZWN0aW9uc1xyXG4gICAgICBjb25zdCB3YWl0VGltZTogbnVtYmVyID0gKDUwMDAgKyAoTWF0aC5yYW5kb20oKSAqIDEwMDAwKSk7XHJcblxyXG4gICAgICBhd2FpdCB3YWl0KHdhaXRUaW1lKTtcclxuICAgICAgLy8gbG9nKGNoYWxrLnllbGxvdyhcIkdldFwiKSwgdXJsKTtcclxuICAgICAgY29uc3QgcmVxdWVzdDogQXhpb3NSZXNwb25zZTxzdHJpbmc+ID0gYXdhaXQgQXhpb3MuZ2V0KHVybCk7XHJcbiAgICAgIC8vIGxvZyhjaGFsay5ncmVlbihcIkdvdFwiKSwgdXJsKTtcclxuICAgICAgd3JpdGUoJz4nKTtcclxuXHJcbiAgICAgIGNvbnN0IGRhdGE6IHN0cmluZyA9IHJlcXVlc3QuZGF0YTtcclxuICAgICAgYXdhaXQgdGhpcy5zZXRDYWNoZShjYWNoZUtleSB8fCB1cmwsIGRhdGEpO1xyXG4gICAgICByZXR1cm4gZGF0YTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19