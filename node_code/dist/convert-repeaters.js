"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("module-alias/register");
const fs_helpers_1 = require("@helpers/fs-helpers");
const log_helpers_1 = require("@helpers/log-helpers");
const i_repeater_structured_1 = require("@interfaces/i-repeater-structured");
const log = log_helpers_1.createLog("Convert Repeaters");
exports.default = (async () => {
    const raw = await fs_helpers_1.getAllFilesFromDirectory("../data/repeaters/results/CO");
    log("Got", raw.length, "files");
    const ids = [];
    const converted = raw
        .reduce((output, input, index) => {
        log("Got", input.length, "repeaters from file", index + 1);
        return [...output, ...input.map(convertRepeater)];
    }, [])
        .filter((repeater) => {
        if (ids.includes(repeater.ID)) {
            return false;
        }
        else {
            ids.push(repeater.ID);
            return true;
        }
    });
    log("Converted", converted.length, "repeaters");
    await fs_helpers_1.writeToJsonAndCsv("../data/repeaters/converted/CO", converted);
})();
function convertRepeater(raw) {
    return {
        ID: convertNumber(raw.ID),
        StateID: convertNumber(raw.state_id),
        Callsign: raw.Call,
        Location: {
            Latitude: raw.Latitude,
            Longitude: raw.Longitude,
            County: raw.County,
            State: raw["ST/PR"],
            Local: raw.Location,
        },
        Use: convertRepeaterUse(raw.Use),
        Status: convertRepeaterStatus(raw["Op Status"]),
        Frequency: { Input: convertNumber(raw.Uplink) || (raw.Downlink + raw.Offset), Output: raw.Downlink },
        SquelchTone: convertRepeaterSquelchTone(raw["Uplink Tone"], raw["Downlink Tone"]),
        DigitalTone: convertRepeaterDigitalTone(raw["Uplink Tone"], raw["Downlink Tone"]),
        Digital: convertRepeaterDigitalData(raw),
        VOIP: convertRepeaterVOIP(raw),
    };
}
function convertRepeaterUse(raw) {
    switch (raw.toLowerCase()) {
        case "open":
            return i_repeater_structured_1.RepeaterUse.Open;
        case "closed":
            return i_repeater_structured_1.RepeaterUse.Closed;
        case "private":
            return i_repeater_structured_1.RepeaterUse.Private;
        default:
            return i_repeater_structured_1.RepeaterUse.Other;
    }
}
function convertRepeaterStatus(raw) {
    if (!raw) {
        return i_repeater_structured_1.RepeaterStatus.Other;
    }
    switch (raw.toLowerCase()) {
        case "on-air":
            return i_repeater_structured_1.RepeaterStatus.OnAir;
        case "off-air":
            return i_repeater_structured_1.RepeaterStatus.OffAir;
        case "testing":
            return i_repeater_structured_1.RepeaterStatus.Testing;
        case "unknown":
            return i_repeater_structured_1.RepeaterStatus.Unknown;
        default:
            return i_repeater_structured_1.RepeaterStatus.Other;
    }
}
function convertRepeaterSquelchTone(rawInput, rawOutput) {
    if (!rawInput && !rawOutput) {
        return undefined;
    }
    const converted = {
        Input: convertNumber(rawInput),
        Output: convertNumber(rawOutput),
    };
    if (converted.Input || converted.Output) {
        return converted;
    }
    return undefined;
}
function convertRepeaterDigitalTone(rawInput, rawOutput) {
    if (!rawInput && !rawOutput) {
        return undefined;
    }
    const digitalFilter = /^D(\d+)$/;
    const converted = {
        Input: typeof rawInput === "string" ? convertNumber(rawInput, digitalFilter) : undefined,
        Output: typeof rawOutput === "string" ? convertNumber(rawOutput, digitalFilter) : undefined,
    };
    if (converted.Input || converted.Output) {
        return converted;
    }
    return undefined;
}
function convertNumber(input, numberFilter = /^([+-]?\d+\.?\d*)$/) {
    if (typeof input === "number" && !isNaN(input)) {
        return input;
    }
    else if (typeof input === "number" && isNaN(input)) {
        return undefined;
    }
    else if (typeof input === "string" && numberFilter.test(input)) {
        const match = input.match(numberFilter);
        if (match && match[1]) {
            const converted = parseFloat(match[1]);
            return !isNaN(converted) ? converted : undefined;
        }
    }
}
function convertRepeaterDigitalData(raw) {
    const converted = {
        // TODO: ATV?: boolean;
        DMR: (raw.DGTL.includes("D") || raw["DMR Enabled"]) ? {
            ColorCode: convertNumber(raw["Color Code"]),
            ID: convertNumber(raw["DMR ID"]),
        } : undefined,
        P25: (raw.DGTL.includes("P") || raw["P-25 Digital Enabled"]) ? { NAC: convertNumber(raw.NAC) } : undefined,
        DStar: (raw.DGTL.includes("S") || raw["D-STAR Enabled"]) ? { Node: raw.Node } : undefined,
        YSF: (raw.DGTL.includes("Y") || raw["YSF Digital Enabled"]) ? {
            GroupID: {
                Input: typeof raw["DG-ID"] === "number" ? raw["DG-ID"] : typeof raw["DG-ID"] === "string" ? raw["DG-ID"].split("/")[0].trim() : undefined,
                Output: typeof raw["DG-ID"] === "number" ? raw["DG-ID"] : typeof raw["DG-ID"] === "string" ? raw["DG-ID"].split("/")[1].trim() : undefined,
            },
        } : undefined,
    };
    if (converted.DMR || converted.P25 || converted.DStar || converted.YSF) {
        return converted;
    }
}
function convertRepeaterVOIP(raw) {
    const converted = {
        AllStar: (raw.VOIP.includes("A") || raw.AllStar) ? { NodeID: convertNumber(raw.AllStar) } : undefined,
        EchoLink: (raw.VOIP.includes("E") || raw.EchoLink) ? {
            NodeID: raw.EchoLink,
        } : undefined,
        IRLP: (raw.VOIP.includes("I") || raw.IRLP) ? { NodeID: convertNumber(raw.IRLP) } : undefined,
        Wires: (raw.VOIP.includes("W") || raw["WIRES-X"]) ? { ID: convertNumber(raw["WIRES-X"]) } : undefined,
    };
    if (converted.AllStar || converted.EchoLink || converted.IRLP || converted.Wires) {
        return converted;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydC1yZXBlYXRlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29udmVydC1yZXBlYXRlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBK0I7QUFFL0Isb0RBQWtGO0FBQ2xGLHNEQUFpRDtBQUVqRCw2RUFNMkM7QUFFM0MsTUFBTSxHQUFHLEdBQTRCLHVCQUFTLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUVwRSxrQkFBZSxDQUFDLEtBQUssSUFBbUIsRUFBRTtJQUN4QyxNQUFNLEdBQUcsR0FBcUIsTUFBTSxxQ0FBd0IsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0lBQzdGLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNoQyxNQUFNLEdBQUcsR0FBYSxFQUFFLENBQUM7SUFDekIsTUFBTSxTQUFTLEdBQTBCLEdBQUc7U0FDekMsTUFBTSxDQUFDLENBQUMsTUFBNkIsRUFBRSxLQUFxQixFQUFFLEtBQWEsRUFBRSxFQUFFO1FBQzlFLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLE1BQU0sRUFBRSxxQkFBcUIsRUFBRSxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDM0QsT0FBTyxDQUFDLEdBQUcsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO0lBQ3BELENBQUMsRUFBRSxFQUFFLENBQUM7U0FDTCxNQUFNLENBQUMsQ0FBQyxRQUE2QixFQUFFLEVBQUU7UUFDeEMsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRTtZQUM3QixPQUFPLEtBQUssQ0FBQztTQUNkO2FBQU07WUFDTCxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN0QixPQUFPLElBQUksQ0FBQztTQUNiO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxHQUFHLENBQUMsV0FBVyxFQUFFLFNBQVMsQ0FBQyxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDaEQsTUFBTSw4QkFBaUIsQ0FBQyxnQ0FBZ0MsRUFBRSxTQUFTLENBQUMsQ0FBQztBQUN2RSxDQUFDLENBQUMsRUFBRSxDQUFDO0FBRUwsU0FBUyxlQUFlLENBQUMsR0FBaUI7SUFDeEMsT0FBTztRQUNMLEVBQUUsRUFBRSxhQUFhLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBVztRQUNuQyxPQUFPLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQVc7UUFDOUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxJQUFJO1FBQ2xCLFFBQVEsRUFBRTtZQUNSLFFBQVEsRUFBRSxHQUFHLENBQUMsUUFBUTtZQUN0QixTQUFTLEVBQUUsR0FBRyxDQUFDLFNBQVM7WUFDeEIsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNO1lBQ2xCLEtBQUssRUFBRSxHQUFHLENBQUMsT0FBTyxDQUFDO1lBQ25CLEtBQUssRUFBRSxHQUFHLENBQUMsUUFBUTtTQUNwQjtRQUNELEdBQUcsRUFBRSxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDO1FBQ2hDLE1BQU0sRUFBRSxxQkFBcUIsQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDL0MsU0FBUyxFQUFFLEVBQUUsS0FBSyxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRSxNQUFNLEVBQUUsR0FBRyxDQUFDLFFBQVEsRUFBRTtRQUNwRyxXQUFXLEVBQUUsMEJBQTBCLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNqRixXQUFXLEVBQUUsMEJBQTBCLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNqRixPQUFPLEVBQUUsMEJBQTBCLENBQUMsR0FBRyxDQUFDO1FBQ3hDLElBQUksRUFBRSxtQkFBbUIsQ0FBQyxHQUFHLENBQUM7S0FDL0IsQ0FBQztBQUNKLENBQUM7QUFFRCxTQUFTLGtCQUFrQixDQUFDLEdBQVc7SUFDckMsUUFBUSxHQUFHLENBQUMsV0FBVyxFQUFFLEVBQUU7UUFDekIsS0FBSyxNQUFNO1lBQ1QsT0FBTyxtQ0FBVyxDQUFDLElBQUksQ0FBQztRQUMxQixLQUFLLFFBQVE7WUFDWCxPQUFPLG1DQUFXLENBQUMsTUFBTSxDQUFDO1FBQzVCLEtBQUssU0FBUztZQUNaLE9BQU8sbUNBQVcsQ0FBQyxPQUFPLENBQUM7UUFDN0I7WUFDRSxPQUFPLG1DQUFXLENBQUMsS0FBSyxDQUFDO0tBQzVCO0FBQ0gsQ0FBQztBQUVELFNBQVMscUJBQXFCLENBQUMsR0FBdUI7SUFDcEQsSUFBSSxDQUFDLEdBQUcsRUFBRTtRQUNSLE9BQU8sc0NBQWMsQ0FBQyxLQUFLLENBQUM7S0FDN0I7SUFDRCxRQUFRLEdBQUcsQ0FBQyxXQUFXLEVBQUUsRUFBRTtRQUN6QixLQUFLLFFBQVE7WUFDWCxPQUFPLHNDQUFjLENBQUMsS0FBSyxDQUFDO1FBQzlCLEtBQUssU0FBUztZQUNaLE9BQU8sc0NBQWMsQ0FBQyxNQUFNLENBQUM7UUFDL0IsS0FBSyxTQUFTO1lBQ1osT0FBTyxzQ0FBYyxDQUFDLE9BQU8sQ0FBQztRQUNoQyxLQUFLLFNBQVM7WUFDWixPQUFPLHNDQUFjLENBQUMsT0FBTyxDQUFDO1FBQ2hDO1lBQ0UsT0FBTyxzQ0FBYyxDQUFDLEtBQUssQ0FBQztLQUMvQjtBQUNILENBQUM7QUFFRCxTQUFTLDBCQUEwQixDQUFDLFFBQXFDLEVBQUUsU0FBc0M7SUFDL0csSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLFNBQVMsRUFBRTtRQUMzQixPQUFPLFNBQVMsQ0FBQztLQUNsQjtJQUNELE1BQU0sU0FBUyxHQUE4RDtRQUMzRSxLQUFLLEVBQUUsYUFBYSxDQUFDLFFBQVEsQ0FBQztRQUM5QixNQUFNLEVBQUUsYUFBYSxDQUFDLFNBQVMsQ0FBQztLQUNqQyxDQUFDO0lBQ0YsSUFBSSxTQUFTLENBQUMsS0FBSyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEVBQUU7UUFDdkMsT0FBTyxTQUFTLENBQUM7S0FDbEI7SUFDRCxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBRUQsU0FBUywwQkFBMEIsQ0FBQyxRQUFxQyxFQUFFLFNBQXNDO0lBQy9HLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxTQUFTLEVBQUU7UUFDM0IsT0FBTyxTQUFTLENBQUM7S0FDbEI7SUFDRCxNQUFNLGFBQWEsR0FBVyxVQUFVLENBQUM7SUFDekMsTUFBTSxTQUFTLEdBQThEO1FBQzNFLEtBQUssRUFBRSxPQUFPLFFBQVEsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxRQUFRLEVBQUUsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVM7UUFDeEYsTUFBTSxFQUFFLE9BQU8sU0FBUyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUztLQUM1RixDQUFDO0lBQ0YsSUFBSSxTQUFTLENBQUMsS0FBSyxJQUFJLFNBQVMsQ0FBQyxNQUFNLEVBQUU7UUFDdkMsT0FBTyxTQUFTLENBQUM7S0FDbEI7SUFDRCxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBRUQsU0FBUyxhQUFhLENBQUMsS0FBa0MsRUFBRSxlQUF1QixvQkFBb0I7SUFDcEcsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDOUMsT0FBTyxLQUFLLENBQUM7S0FDZDtTQUFNLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUNwRCxPQUFPLFNBQVMsQ0FBQztLQUNsQjtTQUFNLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxJQUFJLFlBQVksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDaEUsTUFBTSxLQUFLLEdBQTRCLEtBQUssQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDakUsSUFBSSxLQUFLLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ3JCLE1BQU0sU0FBUyxHQUFXLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQyxPQUFPLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztTQUNsRDtLQUNGO0FBQ0gsQ0FBQztBQUVELFNBQVMsMEJBQTBCLENBQUMsR0FBaUI7SUFDbkQsTUFBTSxTQUFTLEdBQTBCO1FBQ3ZDLHVCQUF1QjtRQUN2QixHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDcEQsU0FBUyxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDM0MsRUFBRSxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDakMsQ0FBQyxDQUFDLENBQUMsU0FBUztRQUNiLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUztRQUMxRyxLQUFLLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVM7UUFDekYsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUQsT0FBTyxFQUFFO2dCQUNQLEtBQUssRUFBRSxPQUFPLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTO2dCQUN6SSxNQUFNLEVBQUUsT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFDLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQyxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUzthQUMzSTtTQUNGLENBQUMsQ0FBQyxDQUFDLFNBQVM7S0FDZCxDQUFDO0lBQ0YsSUFBSSxTQUFTLENBQUMsR0FBRyxJQUFJLFNBQVMsQ0FBQyxHQUFHLElBQUksU0FBUyxDQUFDLEtBQUssSUFBSSxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ3RFLE9BQU8sU0FBUyxDQUFDO0tBQ2xCO0FBQ0gsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsR0FBaUI7SUFDNUMsTUFBTSxTQUFTLEdBQXVCO1FBQ3BDLE9BQU8sRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTO1FBQ3JHLFFBQVEsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkQsTUFBTSxFQUFFLEdBQUcsQ0FBQyxRQUFRO1NBQ3JCLENBQUMsQ0FBQyxDQUFDLFNBQVM7UUFDYixJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUztRQUM1RixLQUFLLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVM7S0FDdEcsQ0FBQztJQUNGLElBQUksU0FBUyxDQUFDLE9BQU8sSUFBSSxTQUFTLENBQUMsUUFBUSxJQUFJLFNBQVMsQ0FBQyxJQUFJLElBQUksU0FBUyxDQUFDLEtBQUssRUFBRTtRQUNoRixPQUFPLFNBQVMsQ0FBQztLQUNsQjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXCJtb2R1bGUtYWxpYXMvcmVnaXN0ZXJcIjtcblxuaW1wb3J0IHsgZ2V0QWxsRmlsZXNGcm9tRGlyZWN0b3J5LCB3cml0ZVRvSnNvbkFuZENzdiB9IGZyb20gXCJAaGVscGVycy9mcy1oZWxwZXJzXCI7XG5pbXBvcnQgeyBjcmVhdGVMb2cgfSBmcm9tIFwiQGhlbHBlcnMvbG9nLWhlbHBlcnNcIjtcbmltcG9ydCB7IElSZXBlYXRlclJhdyB9IGZyb20gXCJAaW50ZXJmYWNlcy9pLXJlcGVhdGVyLXJhd1wiO1xuaW1wb3J0IHtcbiAgSVJlcGVhdGVyRGlnaXRhbE1vZGVzLFxuICBJUmVwZWF0ZXJTdHJ1Y3R1cmVkLFxuICBJUmVwZWF0ZXJWT0lQTW9kZXMsXG4gIFJlcGVhdGVyU3RhdHVzLFxuICBSZXBlYXRlclVzZSxcbn0gZnJvbSBcIkBpbnRlcmZhY2VzL2ktcmVwZWF0ZXItc3RydWN0dXJlZFwiO1xuXG5jb25zdCBsb2c6ICguLi5tc2c6IGFueVtdKSA9PiB2b2lkID0gY3JlYXRlTG9nKFwiQ29udmVydCBSZXBlYXRlcnNcIik7XG5cbmV4cG9ydCBkZWZhdWx0IChhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gIGNvbnN0IHJhdzogSVJlcGVhdGVyUmF3W11bXSA9IGF3YWl0IGdldEFsbEZpbGVzRnJvbURpcmVjdG9yeShcIi4uL2RhdGEvcmVwZWF0ZXJzL3Jlc3VsdHMvQ09cIik7XG4gIGxvZyhcIkdvdFwiLCByYXcubGVuZ3RoLCBcImZpbGVzXCIpO1xuICBjb25zdCBpZHM6IG51bWJlcltdID0gW107XG4gIGNvbnN0IGNvbnZlcnRlZDogSVJlcGVhdGVyU3RydWN0dXJlZFtdID0gcmF3XG4gICAgLnJlZHVjZSgob3V0cHV0OiBJUmVwZWF0ZXJTdHJ1Y3R1cmVkW10sIGlucHV0OiBJUmVwZWF0ZXJSYXdbXSwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgbG9nKFwiR290XCIsIGlucHV0Lmxlbmd0aCwgXCJyZXBlYXRlcnMgZnJvbSBmaWxlXCIsIGluZGV4ICsgMSk7XG4gICAgICByZXR1cm4gWy4uLm91dHB1dCwgLi4uaW5wdXQubWFwKGNvbnZlcnRSZXBlYXRlcildO1xuICAgIH0sIFtdKVxuICAgIC5maWx0ZXIoKHJlcGVhdGVyOiBJUmVwZWF0ZXJTdHJ1Y3R1cmVkKSA9PiB7XG4gICAgICBpZiAoaWRzLmluY2x1ZGVzKHJlcGVhdGVyLklEKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZHMucHVzaChyZXBlYXRlci5JRCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuICBsb2coXCJDb252ZXJ0ZWRcIiwgY29udmVydGVkLmxlbmd0aCwgXCJyZXBlYXRlcnNcIik7XG4gIGF3YWl0IHdyaXRlVG9Kc29uQW5kQ3N2KFwiLi4vZGF0YS9yZXBlYXRlcnMvY29udmVydGVkL0NPXCIsIGNvbnZlcnRlZCk7XG59KSgpO1xuXG5mdW5jdGlvbiBjb252ZXJ0UmVwZWF0ZXIocmF3OiBJUmVwZWF0ZXJSYXcpOiBJUmVwZWF0ZXJTdHJ1Y3R1cmVkIHtcbiAgcmV0dXJuIHtcbiAgICBJRDogY29udmVydE51bWJlcihyYXcuSUQpIGFzIG51bWJlcixcbiAgICBTdGF0ZUlEOiBjb252ZXJ0TnVtYmVyKHJhdy5zdGF0ZV9pZCkgYXMgbnVtYmVyLFxuICAgIENhbGxzaWduOiByYXcuQ2FsbCxcbiAgICBMb2NhdGlvbjoge1xuICAgICAgTGF0aXR1ZGU6IHJhdy5MYXRpdHVkZSxcbiAgICAgIExvbmdpdHVkZTogcmF3LkxvbmdpdHVkZSxcbiAgICAgIENvdW50eTogcmF3LkNvdW50eSxcbiAgICAgIFN0YXRlOiByYXdbXCJTVC9QUlwiXSxcbiAgICAgIExvY2FsOiByYXcuTG9jYXRpb24sXG4gICAgfSxcbiAgICBVc2U6IGNvbnZlcnRSZXBlYXRlclVzZShyYXcuVXNlKSxcbiAgICBTdGF0dXM6IGNvbnZlcnRSZXBlYXRlclN0YXR1cyhyYXdbXCJPcCBTdGF0dXNcIl0pLFxuICAgIEZyZXF1ZW5jeTogeyBJbnB1dDogY29udmVydE51bWJlcihyYXcuVXBsaW5rKSB8fCAocmF3LkRvd25saW5rICsgcmF3Lk9mZnNldCksIE91dHB1dDogcmF3LkRvd25saW5rIH0sXG4gICAgU3F1ZWxjaFRvbmU6IGNvbnZlcnRSZXBlYXRlclNxdWVsY2hUb25lKHJhd1tcIlVwbGluayBUb25lXCJdLCByYXdbXCJEb3dubGluayBUb25lXCJdKSxcbiAgICBEaWdpdGFsVG9uZTogY29udmVydFJlcGVhdGVyRGlnaXRhbFRvbmUocmF3W1wiVXBsaW5rIFRvbmVcIl0sIHJhd1tcIkRvd25saW5rIFRvbmVcIl0pLFxuICAgIERpZ2l0YWw6IGNvbnZlcnRSZXBlYXRlckRpZ2l0YWxEYXRhKHJhdyksXG4gICAgVk9JUDogY29udmVydFJlcGVhdGVyVk9JUChyYXcpLFxuICB9O1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0UmVwZWF0ZXJVc2UocmF3OiBzdHJpbmcpOiBSZXBlYXRlclVzZSB7XG4gIHN3aXRjaCAocmF3LnRvTG93ZXJDYXNlKCkpIHtcbiAgICBjYXNlIFwib3BlblwiOlxuICAgICAgcmV0dXJuIFJlcGVhdGVyVXNlLk9wZW47XG4gICAgY2FzZSBcImNsb3NlZFwiOlxuICAgICAgcmV0dXJuIFJlcGVhdGVyVXNlLkNsb3NlZDtcbiAgICBjYXNlIFwicHJpdmF0ZVwiOlxuICAgICAgcmV0dXJuIFJlcGVhdGVyVXNlLlByaXZhdGU7XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiBSZXBlYXRlclVzZS5PdGhlcjtcbiAgfVxufVxuXG5mdW5jdGlvbiBjb252ZXJ0UmVwZWF0ZXJTdGF0dXMocmF3OiBzdHJpbmcgfCB1bmRlZmluZWQpOiBSZXBlYXRlclN0YXR1cyB7XG4gIGlmICghcmF3KSB7XG4gICAgcmV0dXJuIFJlcGVhdGVyU3RhdHVzLk90aGVyO1xuICB9XG4gIHN3aXRjaCAocmF3LnRvTG93ZXJDYXNlKCkpIHtcbiAgICBjYXNlIFwib24tYWlyXCI6XG4gICAgICByZXR1cm4gUmVwZWF0ZXJTdGF0dXMuT25BaXI7XG4gICAgY2FzZSBcIm9mZi1haXJcIjpcbiAgICAgIHJldHVybiBSZXBlYXRlclN0YXR1cy5PZmZBaXI7XG4gICAgY2FzZSBcInRlc3RpbmdcIjpcbiAgICAgIHJldHVybiBSZXBlYXRlclN0YXR1cy5UZXN0aW5nO1xuICAgIGNhc2UgXCJ1bmtub3duXCI6XG4gICAgICByZXR1cm4gUmVwZWF0ZXJTdGF0dXMuVW5rbm93bjtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIFJlcGVhdGVyU3RhdHVzLk90aGVyO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRSZXBlYXRlclNxdWVsY2hUb25lKHJhd0lucHV0OiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQsIHJhd091dHB1dDogc3RyaW5nIHwgbnVtYmVyIHwgdW5kZWZpbmVkKTogeyBJbnB1dD86IG51bWJlcjsgT3V0cHV0PzogbnVtYmVyIH0gfCB1bmRlZmluZWQge1xuICBpZiAoIXJhd0lucHV0ICYmICFyYXdPdXRwdXQpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG4gIGNvbnN0IGNvbnZlcnRlZDogeyBJbnB1dDogbnVtYmVyIHwgdW5kZWZpbmVkOyBPdXRwdXQ6IG51bWJlciB8IHVuZGVmaW5lZCB9ID0ge1xuICAgIElucHV0OiBjb252ZXJ0TnVtYmVyKHJhd0lucHV0KSxcbiAgICBPdXRwdXQ6IGNvbnZlcnROdW1iZXIocmF3T3V0cHV0KSxcbiAgfTtcbiAgaWYgKGNvbnZlcnRlZC5JbnB1dCB8fCBjb252ZXJ0ZWQuT3V0cHV0KSB7XG4gICAgcmV0dXJuIGNvbnZlcnRlZDtcbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0UmVwZWF0ZXJEaWdpdGFsVG9uZShyYXdJbnB1dDogc3RyaW5nIHwgbnVtYmVyIHwgdW5kZWZpbmVkLCByYXdPdXRwdXQ6IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCk6IHsgSW5wdXQ/OiBudW1iZXI7IE91dHB1dD86IG51bWJlciB9IHwgdW5kZWZpbmVkIHtcbiAgaWYgKCFyYXdJbnB1dCAmJiAhcmF3T3V0cHV0KSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBjb25zdCBkaWdpdGFsRmlsdGVyOiBSZWdFeHAgPSAvXkQoXFxkKykkLztcbiAgY29uc3QgY29udmVydGVkOiB7IElucHV0OiBudW1iZXIgfCB1bmRlZmluZWQ7IE91dHB1dDogbnVtYmVyIHwgdW5kZWZpbmVkIH0gPSB7XG4gICAgSW5wdXQ6IHR5cGVvZiByYXdJbnB1dCA9PT0gXCJzdHJpbmdcIiA/IGNvbnZlcnROdW1iZXIocmF3SW5wdXQsIGRpZ2l0YWxGaWx0ZXIpIDogdW5kZWZpbmVkLFxuICAgIE91dHB1dDogdHlwZW9mIHJhd091dHB1dCA9PT0gXCJzdHJpbmdcIiA/IGNvbnZlcnROdW1iZXIocmF3T3V0cHV0LCBkaWdpdGFsRmlsdGVyKSA6IHVuZGVmaW5lZCxcbiAgfTtcbiAgaWYgKGNvbnZlcnRlZC5JbnB1dCB8fCBjb252ZXJ0ZWQuT3V0cHV0KSB7XG4gICAgcmV0dXJuIGNvbnZlcnRlZDtcbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0TnVtYmVyKGlucHV0OiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQsIG51bWJlckZpbHRlcjogUmVnRXhwID0gL14oWystXT9cXGQrXFwuP1xcZCopJC8pOiBudW1iZXIgfCB1bmRlZmluZWQge1xuICBpZiAodHlwZW9mIGlucHV0ID09PSBcIm51bWJlclwiICYmICFpc05hTihpbnB1dCkpIHtcbiAgICByZXR1cm4gaW5wdXQ7XG4gIH0gZWxzZSBpZiAodHlwZW9mIGlucHV0ID09PSBcIm51bWJlclwiICYmIGlzTmFOKGlucHV0KSkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH0gZWxzZSBpZiAodHlwZW9mIGlucHV0ID09PSBcInN0cmluZ1wiICYmIG51bWJlckZpbHRlci50ZXN0KGlucHV0KSkge1xuICAgIGNvbnN0IG1hdGNoOiBSZWdFeHBNYXRjaEFycmF5IHwgbnVsbCA9IGlucHV0Lm1hdGNoKG51bWJlckZpbHRlcik7XG4gICAgaWYgKG1hdGNoICYmIG1hdGNoWzFdKSB7XG4gICAgICBjb25zdCBjb252ZXJ0ZWQ6IG51bWJlciA9IHBhcnNlRmxvYXQobWF0Y2hbMV0pO1xuICAgICAgcmV0dXJuICFpc05hTihjb252ZXJ0ZWQpID8gY29udmVydGVkIDogdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBjb252ZXJ0UmVwZWF0ZXJEaWdpdGFsRGF0YShyYXc6IElSZXBlYXRlclJhdyk6IElSZXBlYXRlckRpZ2l0YWxNb2RlcyB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IGNvbnZlcnRlZDogSVJlcGVhdGVyRGlnaXRhbE1vZGVzID0ge1xuICAgIC8vIFRPRE86IEFUVj86IGJvb2xlYW47XG4gICAgRE1SOiAocmF3LkRHVEwuaW5jbHVkZXMoXCJEXCIpIHx8IHJhd1tcIkRNUiBFbmFibGVkXCJdKSA/IHtcbiAgICAgIENvbG9yQ29kZTogY29udmVydE51bWJlcihyYXdbXCJDb2xvciBDb2RlXCJdKSxcbiAgICAgIElEOiBjb252ZXJ0TnVtYmVyKHJhd1tcIkRNUiBJRFwiXSksXG4gICAgfSA6IHVuZGVmaW5lZCxcbiAgICBQMjU6IChyYXcuREdUTC5pbmNsdWRlcyhcIlBcIikgfHwgcmF3W1wiUC0yNSBEaWdpdGFsIEVuYWJsZWRcIl0pID8geyBOQUM6IGNvbnZlcnROdW1iZXIocmF3Lk5BQykgfSA6IHVuZGVmaW5lZCxcbiAgICBEU3RhcjogKHJhdy5ER1RMLmluY2x1ZGVzKFwiU1wiKSB8fCByYXdbXCJELVNUQVIgRW5hYmxlZFwiXSkgPyB7IE5vZGU6IHJhdy5Ob2RlIH0gOiB1bmRlZmluZWQsXG4gICAgWVNGOiAocmF3LkRHVEwuaW5jbHVkZXMoXCJZXCIpIHx8IHJhd1tcIllTRiBEaWdpdGFsIEVuYWJsZWRcIl0pID8ge1xuICAgICAgR3JvdXBJRDoge1xuICAgICAgICBJbnB1dDogdHlwZW9mIHJhd1tcIkRHLUlEXCJdID09PSBcIm51bWJlclwiID8gcmF3W1wiREctSURcIl0gOiB0eXBlb2YgcmF3W1wiREctSURcIl0gPT09IFwic3RyaW5nXCIgPyByYXdbXCJERy1JRFwiXS5zcGxpdChcIi9cIilbMF0udHJpbSgpIDogdW5kZWZpbmVkLFxuICAgICAgICBPdXRwdXQ6IHR5cGVvZiByYXdbXCJERy1JRFwiXSA9PT0gXCJudW1iZXJcIiA/IHJhd1tcIkRHLUlEXCJdIDogdHlwZW9mIHJhd1tcIkRHLUlEXCJdID09PSBcInN0cmluZ1wiID8gcmF3W1wiREctSURcIl0uc3BsaXQoXCIvXCIpWzFdLnRyaW0oKSA6IHVuZGVmaW5lZCxcbiAgICAgIH0sXG4gICAgfSA6IHVuZGVmaW5lZCxcbiAgfTtcbiAgaWYgKGNvbnZlcnRlZC5ETVIgfHwgY29udmVydGVkLlAyNSB8fCBjb252ZXJ0ZWQuRFN0YXIgfHwgY29udmVydGVkLllTRikge1xuICAgIHJldHVybiBjb252ZXJ0ZWQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gY29udmVydFJlcGVhdGVyVk9JUChyYXc6IElSZXBlYXRlclJhdyk6IElSZXBlYXRlclZPSVBNb2RlcyB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IGNvbnZlcnRlZDogSVJlcGVhdGVyVk9JUE1vZGVzID0ge1xuICAgIEFsbFN0YXI6IChyYXcuVk9JUC5pbmNsdWRlcyhcIkFcIikgfHwgcmF3LkFsbFN0YXIpID8geyBOb2RlSUQ6IGNvbnZlcnROdW1iZXIocmF3LkFsbFN0YXIpIH0gOiB1bmRlZmluZWQsXG4gICAgRWNob0xpbms6IChyYXcuVk9JUC5pbmNsdWRlcyhcIkVcIikgfHwgcmF3LkVjaG9MaW5rKSA/IHtcbiAgICAgIE5vZGVJRDogcmF3LkVjaG9MaW5rLFxuICAgIH0gOiB1bmRlZmluZWQsIC8vIFRPRE86IFN0YXR1cz86IEVjaG9MaW5rTm9kZVN0YXR1c1xuICAgIElSTFA6IChyYXcuVk9JUC5pbmNsdWRlcyhcIklcIikgfHwgcmF3LklSTFApID8geyBOb2RlSUQ6IGNvbnZlcnROdW1iZXIocmF3LklSTFApIH0gOiB1bmRlZmluZWQsXG4gICAgV2lyZXM6IChyYXcuVk9JUC5pbmNsdWRlcyhcIldcIikgfHwgcmF3W1wiV0lSRVMtWFwiXSkgPyB7IElEOiBjb252ZXJ0TnVtYmVyKHJhd1tcIldJUkVTLVhcIl0pIH0gOiB1bmRlZmluZWQsXG4gIH07XG4gIGlmIChjb252ZXJ0ZWQuQWxsU3RhciB8fCBjb252ZXJ0ZWQuRWNob0xpbmsgfHwgY29udmVydGVkLklSTFAgfHwgY29udmVydGVkLldpcmVzKSB7XG4gICAgcmV0dXJuIGNvbnZlcnRlZDtcbiAgfVxufVxuIl19