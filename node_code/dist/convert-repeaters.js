"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("module-alias/register");
const fs_helpers_1 = require("@helpers/fs-helpers");
const log_helpers_1 = require("@helpers/log-helpers");
const i_repeater_structured_1 = require("@interfaces/i-repeater-structured");
const log = log_helpers_1.createLog('Convert Repeaters');
exports.default = (async () => {
    const raw = await fs_helpers_1.getAllFilesFromDirectory('data/repeaters/results/CO');
    log('Got', raw.length, 'files');
    const ids = [];
    const converted = raw
        .reduce((output, input, index) => {
        log('Got', input.length, 'repeaters from file', index + 1);
        return [...output, ...input.map(convertRepeater)];
    }, [])
        .filter((repeater) => {
        if (ids.includes(repeater.ID)) {
            return false;
        }
        else {
            ids.push(repeater.ID);
            return true;
        }
    });
    log('Converted', converted.length, 'repeaters');
    await fs_helpers_1.writeToJsonAndCsv('data/repeaters/converted/CO', converted);
})();
function convertRepeater(raw) {
    return {
        ID: convertNumber(raw.ID),
        StateID: convertNumber(raw.state_id),
        Callsign: raw.Call,
        Location: { Latitude: raw.Latitude, Longitude: raw.Longitude, County: raw.County, State: raw['ST/PR'], Local: raw.Location },
        Use: convertRepeaterUse(raw.Use),
        Status: convertRepeaterStatus(raw['Op Status']),
        Frequency: { Input: convertNumber(raw.Uplink) || (raw.Downlink + raw.Offset), Output: raw.Downlink },
        SquelchTone: convertRepeaterSquelchTone(raw['Uplink Tone'], raw['Downlink Tone']),
        DigitalTone: convertRepeaterDigitalTone(raw['Uplink Tone'], raw['Downlink Tone']),
        Digital: convertRepeaterDigitalData(raw),
        VOIP: convertRepeaterVOIP(raw),
    };
}
function convertRepeaterUse(raw) {
    switch (raw.toLowerCase()) {
        case 'open':
            return i_repeater_structured_1.RepeaterUse.Open;
        case 'closed':
            return i_repeater_structured_1.RepeaterUse.Closed;
        case 'private':
            return i_repeater_structured_1.RepeaterUse.Private;
        default:
            return i_repeater_structured_1.RepeaterUse.Other;
    }
}
function convertRepeaterStatus(raw) {
    if (!raw) {
        return i_repeater_structured_1.RepeaterStatus.Other;
    }
    switch (raw.toLowerCase()) {
        case 'on-air':
            return i_repeater_structured_1.RepeaterStatus.OnAir;
        case 'off-air':
            return i_repeater_structured_1.RepeaterStatus.OffAir;
        case 'testing':
            return i_repeater_structured_1.RepeaterStatus.Testing;
        case 'unknown':
            return i_repeater_structured_1.RepeaterStatus.Unknown;
        default:
            return i_repeater_structured_1.RepeaterStatus.Other;
    }
}
function convertRepeaterSquelchTone(rawInput, rawOutput) {
    if (!rawInput && !rawOutput) {
        return undefined;
    }
    const converted = {
        Input: convertNumber(rawInput),
        Output: convertNumber(rawOutput),
    };
    if (converted.Input || converted.Output) {
        return converted;
    }
    return undefined;
}
function convertRepeaterDigitalTone(rawInput, rawOutput) {
    if (!rawInput && !rawOutput) {
        return undefined;
    }
    const digitalFilter = /^D(\d+)$/;
    const converted = {
        Input: typeof rawInput === 'string' ? convertNumber(rawInput, digitalFilter) : undefined,
        Output: typeof rawOutput === 'string' ? convertNumber(rawOutput, digitalFilter) : undefined,
    };
    if (converted.Input || converted.Output) {
        return converted;
    }
    return undefined;
}
function convertNumber(input, numberFilter = /^([+-]?\d+\.?\d*)$/) {
    if (typeof input === 'number' && !isNaN(input)) {
        return input;
    }
    else if (typeof input === 'number' && isNaN(input)) {
        return undefined;
    }
    else if (typeof input === 'string' && numberFilter.test(input)) {
        const match = input.match(numberFilter);
        if (match && match[1]) {
            const converted = parseFloat(match[1]);
            return !isNaN(converted) ? converted : undefined;
        }
    }
}
function convertRepeaterDigitalData(raw) {
    const converted = {
        // TODO: ATV?: boolean;
        DMR: (raw.DGTL.includes('D') || raw['DMR Enabled']) ? { ColorCode: convertNumber(raw['Color Code']), ID: convertNumber(raw['DMR ID']) } : undefined,
        P25: (raw.DGTL.includes('P') || raw['P-25 Digital Enabled']) ? { NAC: convertNumber(raw.NAC) } : undefined,
        DStar: (raw.DGTL.includes('S') || raw['D-STAR Enabled']) ? { Node: raw.Node } : undefined,
        YSF: (raw.DGTL.includes('Y') || raw['YSF Digital Enabled']) ? {
            GroupID: {
                Input: typeof raw['DG-ID'] === 'number' ? raw['DG-ID'] : typeof raw['DG-ID'] === 'string' ? raw['DG-ID'].split('/')[0].trim() : undefined,
                Output: typeof raw['DG-ID'] === 'number' ? raw['DG-ID'] : typeof raw['DG-ID'] === 'string' ? raw['DG-ID'].split('/')[1].trim() : undefined,
            },
        } : undefined,
    };
    if (converted.DMR || converted.P25 || converted.DStar || converted.YSF) {
        return converted;
    }
}
function convertRepeaterVOIP(raw) {
    const converted = {
        AllStar: (raw.VOIP.includes('A') || raw.AllStar) ? { NodeID: convertNumber(raw.AllStar) } : undefined,
        EchoLink: (raw.VOIP.includes('E') || raw.EchoLink) ? {
            NodeID: raw.EchoLink,
        } : undefined,
        IRLP: (raw.VOIP.includes('I') || raw.IRLP) ? { NodeID: convertNumber(raw.IRLP) } : undefined,
        Wires: (raw.VOIP.includes('W') || raw['WIRES-X']) ? { ID: convertNumber(raw['WIRES-X']) } : undefined,
    };
    if (converted.AllStar || converted.EchoLink || converted.IRLP || converted.Wires) {
        return converted;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydC1yZXBlYXRlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29udmVydC1yZXBlYXRlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBK0I7QUFFL0Isb0RBQWtGO0FBQ2xGLHNEQUFpRDtBQUVqRCw2RUFNMkM7QUFFM0MsTUFBTSxHQUFHLEdBQTRCLHVCQUFTLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUVwRSxrQkFBZSxDQUFDLEtBQUssSUFBbUIsRUFBRTtJQUN4QyxNQUFNLEdBQUcsR0FBcUIsTUFBTSxxQ0FBd0IsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0lBQzFGLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNoQyxNQUFNLEdBQUcsR0FBYSxFQUFFLENBQUM7SUFDekIsTUFBTSxTQUFTLEdBQTBCLEdBQUc7U0FDekMsTUFBTSxDQUFDLENBQUMsTUFBNkIsRUFBRSxLQUFxQixFQUFFLEtBQWEsRUFBRSxFQUFFO1FBQzlFLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLE1BQU0sRUFBRSxxQkFBcUIsRUFBRSxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDM0QsT0FBTyxDQUFDLEdBQUcsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO0lBQ3BELENBQUMsRUFBRSxFQUFFLENBQUM7U0FDTCxNQUFNLENBQUMsQ0FBQyxRQUE2QixFQUFFLEVBQUU7UUFDeEMsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRTtZQUM3QixPQUFPLEtBQUssQ0FBQztTQUNkO2FBQU07WUFDTCxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN0QixPQUFPLElBQUksQ0FBQztTQUNiO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFD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LENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTO1FBQ3JHLFFBQVEsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkQsTUFBTSxFQUFFLEdBQUcsQ0FBQyxRQUFRO1NBQ3JCLENBQUMsQ0FBQyxDQUFDLFNBQVM7UUFDYixJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUztRQUM1RixLQUFLLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVM7S0FDdEcsQ0FBQztJQUNGLElBQUksU0FBUyxDQUFDLE9BQU8sSUFBSSxTQUFTLENBQUMsUUFBUSxJQUFJLFNBQVMsQ0FBQyxJQUFJLElBQUksU0FBUyxDQUFDLEtBQUssRUFBRTtRQUNoRixPQUFPLFNBQVMsQ0FBQztLQUNsQjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJ21vZHVsZS1hbGlhcy9yZWdpc3Rlcic7XHJcblxyXG5pbXBvcnQgeyBnZXRBbGxGaWxlc0Zyb21EaXJlY3RvcnksIHdyaXRlVG9Kc29uQW5kQ3N2IH0gZnJvbSAnQGhlbHBlcnMvZnMtaGVscGVycyc7XHJcbmltcG9ydCB7IGNyZWF0ZUxvZyB9IGZyb20gJ0BoZWxwZXJzL2xvZy1oZWxwZXJzJztcclxuaW1wb3J0IHsgSVJlcGVhdGVyUmF3IH0gZnJvbSAnQGludGVyZmFjZXMvaS1yZXBlYXRlci1yYXcnO1xyXG5pbXBvcnQge1xyXG4gIElSZXBlYXRlckRpZ2l0YWxNb2RlcyxcclxuICBJUmVwZWF0ZXJTdHJ1Y3R1cmVkLFxyXG4gIElSZXBlYXRlclZPSVBNb2RlcyxcclxuICBSZXBlYXRlclN0YXR1cyxcclxuICBSZXBlYXRlclVzZSxcclxufSBmcm9tICdAaW50ZXJmYWNlcy9pLXJlcGVhdGVyLXN0cnVjdHVyZWQnO1xyXG5cclxuY29uc3QgbG9nOiAoLi4ubXNnOiBhbnlbXSkgPT4gdm9pZCA9IGNyZWF0ZUxvZygnQ29udmVydCBSZXBlYXRlcnMnKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IChhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XHJcbiAgY29uc3QgcmF3OiBJUmVwZWF0ZXJSYXdbXVtdID0gYXdhaXQgZ2V0QWxsRmlsZXNGcm9tRGlyZWN0b3J5KCdkYXRhL3JlcGVhdGVycy9yZXN1bHRzL0NPJyk7XHJcbiAgbG9nKCdHb3QnLCByYXcubGVuZ3RoLCAnZmlsZXMnKTtcclxuICBjb25zdCBpZHM6IG51bWJlcltdID0gW107XHJcbiAgY29uc3QgY29udmVydGVkOiBJUmVwZWF0ZXJTdHJ1Y3R1cmVkW10gPSByYXdcclxuICAgIC5yZWR1Y2UoKG91dHB1dDogSVJlcGVhdGVyU3RydWN0dXJlZFtdLCBpbnB1dDogSVJlcGVhdGVyUmF3W10sIGluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgbG9nKCdHb3QnLCBpbnB1dC5sZW5ndGgsICdyZXBlYXRlcnMgZnJvbSBmaWxlJywgaW5kZXggKyAxKTtcclxuICAgICAgcmV0dXJuIFsuLi5vdXRwdXQsIC4uLmlucHV0Lm1hcChjb252ZXJ0UmVwZWF0ZXIpXTtcclxuICAgIH0sIFtdKVxyXG4gICAgLmZpbHRlcigocmVwZWF0ZXI6IElSZXBlYXRlclN0cnVjdHVyZWQpID0+IHtcclxuICAgICAgaWYgKGlkcy5pbmNsdWRlcyhyZXBlYXRlci5JRCkpIHtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgaWRzLnB1c2gocmVwZWF0ZXIuSUQpO1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICBsb2coJ0NvbnZlcnRlZCcsIGNvbnZlcnRlZC5sZW5ndGgsICdyZXBlYXRlcnMnKTtcclxuICBhd2FpdCB3cml0ZVRvSnNvbkFuZENzdignZGF0YS9yZXBlYXRlcnMvY29udmVydGVkL0NPJywgY29udmVydGVkKTtcclxufSkoKTtcclxuXHJcbmZ1bmN0aW9uIGNvbnZlcnRSZXBlYXRlcihyYXc6IElSZXBlYXRlclJhdyk6IElSZXBlYXRlclN0cnVjdHVyZWQge1xyXG4gIHJldHVybiB7XHJcbiAgICBJRDogY29udmVydE51bWJlcihyYXcuSUQpIGFzIG51bWJlcixcclxuICAgIFN0YXRlSUQ6IGNvbnZlcnROdW1iZXIocmF3LnN0YXRlX2lkKSBhcyBudW1iZXIsXHJcbiAgICBDYWxsc2lnbjogcmF3LkNhbGwsXHJcbiAgICBMb2NhdGlvbjogeyBMYXRpdHVkZTogcmF3LkxhdGl0dWRlLCBMb25naXR1ZGU6IHJhdy5Mb25naXR1ZGUsIENvdW50eTogcmF3LkNvdW50eSwgU3RhdGU6IHJhd1snU1QvUFInXSwgTG9jYWw6IHJhdy5Mb2NhdGlvbiB9LFxyXG4gICAgVXNlOiBjb252ZXJ0UmVwZWF0ZXJVc2UocmF3LlVzZSksXHJcbiAgICBTdGF0dXM6IGNvbnZlcnRSZXBlYXRlclN0YXR1cyhyYXdbJ09wIFN0YXR1cyddKSxcclxuICAgIEZyZXF1ZW5jeTogeyBJbnB1dDogY29udmVydE51bWJlcihyYXcuVXBsaW5rKSB8fCAocmF3LkRvd25saW5rICsgcmF3Lk9mZnNldCksIE91dHB1dDogcmF3LkRvd25saW5rIH0sXHJcbiAgICBTcXVlbGNoVG9uZTogY29udmVydFJlcGVhdGVyU3F1ZWxjaFRvbmUocmF3WydVcGxpbmsgVG9uZSddLCByYXdbJ0Rvd25saW5rIFRvbmUnXSksXHJcbiAgICBEaWdpdGFsVG9uZTogY29udmVydFJlcGVhdGVyRGlnaXRhbFRvbmUocmF3WydVcGxpbmsgVG9uZSddLCByYXdbJ0Rvd25saW5rIFRvbmUnXSksXHJcbiAgICBEaWdpdGFsOiBjb252ZXJ0UmVwZWF0ZXJEaWdpdGFsRGF0YShyYXcpLFxyXG4gICAgVk9JUDogY29udmVydFJlcGVhdGVyVk9JUChyYXcpLFxyXG4gIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbnZlcnRSZXBlYXRlclVzZShyYXc6IHN0cmluZyk6IFJlcGVhdGVyVXNlIHtcclxuICBzd2l0Y2ggKHJhdy50b0xvd2VyQ2FzZSgpKSB7XHJcbiAgICBjYXNlICdvcGVuJzpcclxuICAgICAgcmV0dXJuIFJlcGVhdGVyVXNlLk9wZW47XHJcbiAgICBjYXNlICdjbG9zZWQnOlxyXG4gICAgICByZXR1cm4gUmVwZWF0ZXJVc2UuQ2xvc2VkO1xyXG4gICAgY2FzZSAncHJpdmF0ZSc6XHJcbiAgICAgIHJldHVybiBSZXBlYXRlclVzZS5Qcml2YXRlO1xyXG4gICAgZGVmYXVsdDpcclxuICAgICAgcmV0dXJuIFJlcGVhdGVyVXNlLk90aGVyO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gY29udmVydFJlcGVhdGVyU3RhdHVzKHJhdzogc3RyaW5nIHwgdW5kZWZpbmVkKTogUmVwZWF0ZXJTdGF0dXMge1xyXG4gIGlmICghcmF3KSB7XHJcbiAgICByZXR1cm4gUmVwZWF0ZXJTdGF0dXMuT3RoZXI7XHJcbiAgfVxyXG4gIHN3aXRjaCAocmF3LnRvTG93ZXJDYXNlKCkpIHtcclxuICAgIGNhc2UgJ29uLWFpcic6XHJcbiAgICAgIHJldHVybiBSZXBlYXRlclN0YXR1cy5PbkFpcjtcclxuICAgIGNhc2UgJ29mZi1haXInOlxyXG4gICAgICByZXR1cm4gUmVwZWF0ZXJTdGF0dXMuT2ZmQWlyO1xyXG4gICAgY2FzZSAndGVzdGluZyc6XHJcbiAgICAgIHJldHVybiBSZXBlYXRlclN0YXR1cy5UZXN0aW5nO1xyXG4gICAgY2FzZSAndW5rbm93bic6XHJcbiAgICAgIHJldHVybiBSZXBlYXRlclN0YXR1cy5Vbmtub3duO1xyXG4gICAgZGVmYXVsdDpcclxuICAgICAgcmV0dXJuIFJlcGVhdGVyU3RhdHVzLk90aGVyO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gY29udmVydFJlcGVhdGVyU3F1ZWxjaFRvbmUocmF3SW5wdXQ6IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCwgcmF3T3V0cHV0OiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQpOiB7IElucHV0PzogbnVtYmVyOyBPdXRwdXQ/OiBudW1iZXIgfSB8IHVuZGVmaW5lZCB7XHJcbiAgaWYgKCFyYXdJbnB1dCAmJiAhcmF3T3V0cHV0KSB7XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH1cclxuICBjb25zdCBjb252ZXJ0ZWQ6IHsgSW5wdXQ6IG51bWJlciB8IHVuZGVmaW5lZDsgT3V0cHV0OiBudW1iZXIgfCB1bmRlZmluZWQgfSA9IHtcclxuICAgIElucHV0OiBjb252ZXJ0TnVtYmVyKHJhd0lucHV0KSxcclxuICAgIE91dHB1dDogY29udmVydE51bWJlcihyYXdPdXRwdXQpLFxyXG4gIH07XHJcbiAgaWYgKGNvbnZlcnRlZC5JbnB1dCB8fCBjb252ZXJ0ZWQuT3V0cHV0KSB7XHJcbiAgICByZXR1cm4gY29udmVydGVkO1xyXG4gIH1cclxuICByZXR1cm4gdW5kZWZpbmVkO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb252ZXJ0UmVwZWF0ZXJEaWdpdGFsVG9uZShyYXdJbnB1dDogc3RyaW5nIHwgbnVtYmVyIHwgdW5kZWZpbmVkLCByYXdPdXRwdXQ6IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCk6IHsgSW5wdXQ/OiBudW1iZXI7IE91dHB1dD86IG51bWJlciB9IHwgdW5kZWZpbmVkIHtcclxuICBpZiAoIXJhd0lucHV0ICYmICFyYXdPdXRwdXQpIHtcclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIGNvbnN0IGRpZ2l0YWxGaWx0ZXI6IFJlZ0V4cCA9IC9eRChcXGQrKSQvO1xyXG4gIGNvbnN0IGNvbnZlcnRlZDogeyBJbnB1dDogbnVtYmVyIHwgdW5kZWZpbmVkOyBPdXRwdXQ6IG51bWJlciB8IHVuZGVmaW5lZCB9ID0ge1xyXG4gICAgSW5wdXQ6IHR5cGVvZiByYXdJbnB1dCA9PT0gJ3N0cmluZycgPyBjb252ZXJ0TnVtYmVyKHJhd0lucHV0LCBkaWdpdGFsRmlsdGVyKSA6IHVuZGVmaW5lZCxcclxuICAgIE91dHB1dDogdHlwZW9mIHJhd091dHB1dCA9PT0gJ3N0cmluZycgPyBjb252ZXJ0TnVtYmVyKHJhd091dHB1dCwgZGlnaXRhbEZpbHRlcikgOiB1bmRlZmluZWQsXHJcbiAgfTtcclxuICBpZiAoY29udmVydGVkLklucHV0IHx8IGNvbnZlcnRlZC5PdXRwdXQpIHtcclxuICAgIHJldHVybiBjb252ZXJ0ZWQ7XHJcbiAgfVxyXG4gIHJldHVybiB1bmRlZmluZWQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbnZlcnROdW1iZXIoaW5wdXQ6IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCwgbnVtYmVyRmlsdGVyOiBSZWdFeHAgPSAvXihbKy1dP1xcZCtcXC4/XFxkKikkLyk6IG51bWJlciB8IHVuZGVmaW5lZCB7XHJcbiAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ251bWJlcicgJiYgIWlzTmFOKGlucHV0KSkge1xyXG4gICAgcmV0dXJuIGlucHV0O1xyXG4gIH0gZWxzZSBpZiAodHlwZW9mIGlucHV0ID09PSAnbnVtYmVyJyAmJiBpc05hTihpbnB1dCkpIHtcclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfSBlbHNlIGlmICh0eXBlb2YgaW5wdXQgPT09ICdzdHJpbmcnICYmIG51bWJlckZpbHRlci50ZXN0KGlucHV0KSkge1xyXG4gICAgY29uc3QgbWF0Y2g6IFJlZ0V4cE1hdGNoQXJyYXkgfCBudWxsID0gaW5wdXQubWF0Y2gobnVtYmVyRmlsdGVyKTtcclxuICAgIGlmIChtYXRjaCAmJiBtYXRjaFsxXSkge1xyXG4gICAgICBjb25zdCBjb252ZXJ0ZWQ6IG51bWJlciA9IHBhcnNlRmxvYXQobWF0Y2hbMV0pO1xyXG4gICAgICByZXR1cm4gIWlzTmFOKGNvbnZlcnRlZCkgPyBjb252ZXJ0ZWQgOiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjb252ZXJ0UmVwZWF0ZXJEaWdpdGFsRGF0YShyYXc6IElSZXBlYXRlclJhdyk6IElSZXBlYXRlckRpZ2l0YWxNb2RlcyB8IHVuZGVmaW5lZCB7XHJcbiAgY29uc3QgY29udmVydGVkOiBJUmVwZWF0ZXJEaWdpdGFsTW9kZXMgPSB7XHJcbiAgICAvLyBUT0RPOiBBVFY/OiBib29sZWFuO1xyXG4gICAgRE1SOiAocmF3LkRHVEwuaW5jbHVkZXMoJ0QnKSB8fCByYXdbJ0RNUiBFbmFibGVkJ10pID8geyBDb2xvckNvZGU6IGNvbnZlcnROdW1iZXIocmF3WydDb2xvciBDb2RlJ10pLCBJRDogY29udmVydE51bWJlcihyYXdbJ0RNUiBJRCddKSB9IDogdW5kZWZpbmVkLFxyXG4gICAgUDI1OiAocmF3LkRHVEwuaW5jbHVkZXMoJ1AnKSB8fCByYXdbJ1AtMjUgRGlnaXRhbCBFbmFibGVkJ10pID8geyBOQUM6IGNvbnZlcnROdW1iZXIocmF3Lk5BQykgfSA6IHVuZGVmaW5lZCxcclxuICAgIERTdGFyOiAocmF3LkRHVEwuaW5jbHVkZXMoJ1MnKSB8fCByYXdbJ0QtU1RBUiBFbmFibGVkJ10pID8geyBOb2RlOiByYXcuTm9kZSB9IDogdW5kZWZpbmVkLFxyXG4gICAgWVNGOiAocmF3LkRHVEwuaW5jbHVkZXMoJ1knKSB8fCByYXdbJ1lTRiBEaWdpdGFsIEVuYWJsZWQnXSkgPyB7XHJcbiAgICAgIEdyb3VwSUQ6IHtcclxuICAgICAgICBJbnB1dDogdHlwZW9mIHJhd1snREctSUQnXSA9PT0gJ251bWJlcicgPyByYXdbJ0RHLUlEJ10gOiB0eXBlb2YgcmF3WydERy1JRCddID09PSAnc3RyaW5nJyA/IHJhd1snREctSUQnXS5zcGxpdCgnLycpWzBdLnRyaW0oKSA6IHVuZGVmaW5lZCxcclxuICAgICAgICBPdXRwdXQ6IHR5cGVvZiByYXdbJ0RHLUlEJ10gPT09ICdudW1iZXInID8gcmF3WydERy1JRCddIDogdHlwZW9mIHJhd1snREctSUQnXSA9PT0gJ3N0cmluZycgPyByYXdbJ0RHLUlEJ10uc3BsaXQoJy8nKVsxXS50cmltKCkgOiB1bmRlZmluZWQsXHJcbiAgICAgIH0sXHJcbiAgICB9IDogdW5kZWZpbmVkLFxyXG4gIH07XHJcbiAgaWYgKGNvbnZlcnRlZC5ETVIgfHwgY29udmVydGVkLlAyNSB8fCBjb252ZXJ0ZWQuRFN0YXIgfHwgY29udmVydGVkLllTRikge1xyXG4gICAgcmV0dXJuIGNvbnZlcnRlZDtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbnZlcnRSZXBlYXRlclZPSVAocmF3OiBJUmVwZWF0ZXJSYXcpOiBJUmVwZWF0ZXJWT0lQTW9kZXMgfCB1bmRlZmluZWQge1xyXG4gIGNvbnN0IGNvbnZlcnRlZDogSVJlcGVhdGVyVk9JUE1vZGVzID0ge1xyXG4gICAgQWxsU3RhcjogKHJhdy5WT0lQLmluY2x1ZGVzKCdBJykgfHwgcmF3LkFsbFN0YXIpID8geyBOb2RlSUQ6IGNvbnZlcnROdW1iZXIocmF3LkFsbFN0YXIpIH0gOiB1bmRlZmluZWQsXHJcbiAgICBFY2hvTGluazogKHJhdy5WT0lQLmluY2x1ZGVzKCdFJykgfHwgcmF3LkVjaG9MaW5rKSA/IHtcclxuICAgICAgTm9kZUlEOiByYXcuRWNob0xpbmssXHJcbiAgICB9IDogdW5kZWZpbmVkLCAvLyBUT0RPOiBTdGF0dXM/OiBFY2hvTGlua05vZGVTdGF0dXNcclxuICAgIElSTFA6IChyYXcuVk9JUC5pbmNsdWRlcygnSScpIHx8IHJhdy5JUkxQKSA/IHsgTm9kZUlEOiBjb252ZXJ0TnVtYmVyKHJhdy5JUkxQKSB9IDogdW5kZWZpbmVkLFxyXG4gICAgV2lyZXM6IChyYXcuVk9JUC5pbmNsdWRlcygnVycpIHx8IHJhd1snV0lSRVMtWCddKSA/IHsgSUQ6IGNvbnZlcnROdW1iZXIocmF3WydXSVJFUy1YJ10pIH0gOiB1bmRlZmluZWQsXHJcbiAgfTtcclxuICBpZiAoY29udmVydGVkLkFsbFN0YXIgfHwgY29udmVydGVkLkVjaG9MaW5rIHx8IGNvbnZlcnRlZC5JUkxQIHx8IGNvbnZlcnRlZC5XaXJlcykge1xyXG4gICAgcmV0dXJuIGNvbnZlcnRlZDtcclxuICB9XHJcbn1cclxuIl19