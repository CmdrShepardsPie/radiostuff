"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("module-alias/register");
const fs_helpers_1 = require("@helpers/fs-helpers");
const log_helpers_1 = require("@helpers/log-helpers");
const i_repeater_structured_1 = require("@interfaces/i-repeater-structured");
const log = log_helpers_1.createLog("Convert Repeaters");
exports.default = (async () => {
    const raw = await fs_helpers_1.getAllFilesFromDirectory("../data/repeaters/results/CO");
    log("Got", raw.length, "files");
    const ids = [];
    const converted = raw
        .reduce((output, input, index) => {
        log("Got", input.length, "repeaters from file", index + 1);
        return [...output, ...input.map(convertRepeater)];
    }, [])
        .filter((repeater) => {
        if (ids.includes(repeater.ID)) {
            return false;
        }
        else {
            ids.push(repeater.ID);
            return true;
        }
    });
    log("Converted", converted.length, "repeaters");
    await fs_helpers_1.writeToJsonAndCsv("../data/repeaters/converted/CO", converted);
})();
function convertRepeater(raw) {
    return {
        ID: convertNumber(raw.ID),
        StateID: convertNumber(raw.state_id),
        Callsign: raw.Call,
        Location: {
            Latitude: raw.Latitude,
            Longitude: raw.Longitude,
            County: raw.County,
            State: raw["ST/PR"],
            Local: raw.Location,
        },
        Use: convertRepeaterUse(raw.Use),
        Status: convertRepeaterStatus(raw["Op Status"]),
        Frequency: { Input: convertNumber(raw.Uplink) || (raw.Downlink + raw.Offset), Output: raw.Downlink },
        SquelchTone: convertRepeaterSquelchTone(raw["Uplink Tone"], raw["Downlink Tone"]),
        DigitalTone: convertRepeaterDigitalTone(raw["Uplink Tone"], raw["Downlink Tone"]),
        Digital: convertRepeaterDigitalData(raw),
        VOIP: convertRepeaterVOIP(raw),
    };
}
function convertRepeaterUse(raw) {
    switch (raw.toLowerCase()) {
        case "open":
            return i_repeater_structured_1.RepeaterUse.Open;
        case "closed":
            return i_repeater_structured_1.RepeaterUse.Closed;
        case "private":
            return i_repeater_structured_1.RepeaterUse.Private;
        default:
            return i_repeater_structured_1.RepeaterUse.Other;
    }
}
function convertRepeaterStatus(raw) {
    if (!raw) {
        return i_repeater_structured_1.RepeaterStatus.Other;
    }
    switch (raw.toLowerCase()) {
        case "on-air":
            return i_repeater_structured_1.RepeaterStatus.OnAir;
        case "off-air":
            return i_repeater_structured_1.RepeaterStatus.OffAir;
        case "testing":
            return i_repeater_structured_1.RepeaterStatus.Testing;
        case "unknown":
            return i_repeater_structured_1.RepeaterStatus.Unknown;
        default:
            return i_repeater_structured_1.RepeaterStatus.Other;
    }
}
function convertRepeaterSquelchTone(rawInput, rawOutput) {
    if (!rawInput && !rawOutput) {
        return undefined;
    }
    const converted = {
        Input: convertNumber(rawInput),
        Output: convertNumber(rawOutput),
    };
    if (converted.Input || converted.Output) {
        return converted;
    }
    return undefined;
}
function convertRepeaterDigitalTone(rawInput, rawOutput) {
    if (!rawInput && !rawOutput) {
        return undefined;
    }
    const digitalFilter = /^D(\d+)$/;
    const converted = {
        Input: typeof rawInput === "string" ? convertNumber(rawInput, digitalFilter) : undefined,
        Output: typeof rawOutput === "string" ? convertNumber(rawOutput, digitalFilter) : undefined,
    };
    if (converted.Input || converted.Output) {
        return converted;
    }
    return undefined;
}
function convertNumber(input, numberFilter = /^([+-]?\d+\.?\d*)$/) {
    if (typeof input === "number" && !isNaN(input)) {
        return input;
    }
    else if (typeof input === "number" && isNaN(input)) {
        return undefined;
    }
    else if (typeof input === "string" && numberFilter.test(input)) {
        const match = input.match(numberFilter);
        if (match && match[1]) {
            const converted = parseFloat(match[1]);
            return !isNaN(converted) ? converted : undefined;
        }
    }
}
function convertRepeaterDigitalData(raw) {
    const converted = {
        // TODO: ATV?: boolean;
        DMR: (raw.DGTL.includes("D") || raw["DMR Enabled"]) ? {
            ColorCode: convertNumber(raw["Color Code"]),
            ID: convertNumber(raw["DMR ID"]),
        } : undefined,
        P25: (raw.DGTL.includes("P") || raw["P-25 Digital Enabled"]) ? { NAC: convertNumber(raw.NAC) } : undefined,
        DStar: (raw.DGTL.includes("S") || raw["D-STAR Enabled"]) ? { Node: raw.Node } : undefined,
        YSF: (raw.DGTL.includes("Y") || raw["YSF Digital Enabled"]) ? {
            GroupID: {
                Input: typeof raw["DG-ID"] === "number" ? raw["DG-ID"] : typeof raw["DG-ID"] === "string" ? raw["DG-ID"].split("/")[0].trim() : undefined,
                Output: typeof raw["DG-ID"] === "number" ? raw["DG-ID"] : typeof raw["DG-ID"] === "string" ? raw["DG-ID"].split("/")[1].trim() : undefined,
            },
        } : undefined,
    };
    if (converted.DMR || converted.P25 || converted.DStar || converted.YSF) {
        return converted;
    }
}
function convertRepeaterVOIP(raw) {
    const converted = {
        AllStar: (raw.VOIP.includes("A") || raw.AllStar) ? { NodeID: convertNumber(raw.AllStar) } : undefined,
        EchoLink: (raw.VOIP.includes("E") || raw.EchoLink) ? {
            NodeID: raw.EchoLink,
        } : undefined,
        IRLP: (raw.VOIP.includes("I") || raw.IRLP) ? { NodeID: convertNumber(raw.IRLP) } : undefined,
        Wires: (raw.VOIP.includes("W") || raw["WIRES-X"]) ? { ID: convertNumber(raw["WIRES-X"]) } : undefined,
    };
    if (converted.AllStar || converted.EchoLink || converted.IRLP || converted.Wires) {
        return converted;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydC1yZXBlYXRlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvY29udmVydC1yZXBlYXRlcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBK0I7QUFFL0Isb0RBQWtGO0FBQ2xGLHNEQUFpRDtBQUVqRCw2RUFNMkM7QUFFM0MsTUFBTSxHQUFHLEdBQTRCLHVCQUFTLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUVwRSxrQkFBZSxDQUFDLEtBQUssSUFBbUIsRUFBRTtJQUN4QyxNQUFNLEdBQUcsR0FBcUIsTUFBTSxxQ0FBd0IsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0lBQzdGLEdBQUcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUNoQyxNQUFNLEdBQUcsR0FBYSxFQUFFLENBQUM7SUFDekIsTUFBTSxTQUFTLEdBQTBCLEdBQUc7U0FDekMsTUFBTSxDQUFDLENBQUMsTUFBNkIsRUFBRSxLQUFxQixFQUFFLEtBQWEsRUFBRSxFQUFFO1FBQzlFLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLE1BQU0sRUFBRSxxQkFBcUIsRUFBRSxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDM0QsT0FBTyxDQUFDLEdBQUcsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO0lBQ3BELENBQUMsRUFBRSxFQUFFLENBQUM7U0FDTCxNQUFNLENBQUMsQ0FBQyxRQUE2QixFQUFFLEVBQUU7UUFDeEMsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsRUFBRTtZQUM3QixPQUFPLEtBQUssQ0FBQztTQUNkO2FBQU07WUFDTCxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN0QixPQUFPLElBQUksQ0FBQztTQUNiO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFD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QyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTO1FBQ3JHLFFBQVEsRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkQsTUFBTSxFQUFFLEdBQUcsQ0FBQyxRQUFRO1NBQ3JCLENBQUMsQ0FBQyxDQUFDLFNBQVM7UUFDYixJQUFJLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUztRQUM1RixLQUFLLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVM7S0FDdEcsQ0FBQztJQUNGLElBQUksU0FBUyxDQUFDLE9BQU8sSUFBSSxTQUFTLENBQUMsUUFBUSxJQUFJLFNBQVMsQ0FBQyxJQUFJLElBQUksU0FBUyxDQUFDLEtBQUssRUFBRTtRQUNoRixPQUFPLFNBQVMsQ0FBQztLQUNsQjtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXCJtb2R1bGUtYWxpYXMvcmVnaXN0ZXJcIjtcclxuXHJcbmltcG9ydCB7IGdldEFsbEZpbGVzRnJvbURpcmVjdG9yeSwgd3JpdGVUb0pzb25BbmRDc3YgfSBmcm9tIFwiQGhlbHBlcnMvZnMtaGVscGVyc1wiO1xyXG5pbXBvcnQgeyBjcmVhdGVMb2cgfSBmcm9tIFwiQGhlbHBlcnMvbG9nLWhlbHBlcnNcIjtcclxuaW1wb3J0IHsgSVJlcGVhdGVyUmF3IH0gZnJvbSBcIkBpbnRlcmZhY2VzL2ktcmVwZWF0ZXItcmF3XCI7XHJcbmltcG9ydCB7XHJcbiAgSVJlcGVhdGVyRGlnaXRhbE1vZGVzLFxyXG4gIElSZXBlYXRlclN0cnVjdHVyZWQsXHJcbiAgSVJlcGVhdGVyVk9JUE1vZGVzLFxyXG4gIFJlcGVhdGVyU3RhdHVzLFxyXG4gIFJlcGVhdGVyVXNlLFxyXG59IGZyb20gXCJAaW50ZXJmYWNlcy9pLXJlcGVhdGVyLXN0cnVjdHVyZWRcIjtcclxuXHJcbmNvbnN0IGxvZzogKC4uLm1zZzogYW55W10pID0+IHZvaWQgPSBjcmVhdGVMb2coXCJDb252ZXJ0IFJlcGVhdGVyc1wiKTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IChhc3luYyAoKTogUHJvbWlzZTx2b2lkPiA9PiB7XHJcbiAgY29uc3QgcmF3OiBJUmVwZWF0ZXJSYXdbXVtdID0gYXdhaXQgZ2V0QWxsRmlsZXNGcm9tRGlyZWN0b3J5KFwiLi4vZGF0YS9yZXBlYXRlcnMvcmVzdWx0cy9DT1wiKTtcclxuICBsb2coXCJHb3RcIiwgcmF3Lmxlbmd0aCwgXCJmaWxlc1wiKTtcclxuICBjb25zdCBpZHM6IG51bWJlcltdID0gW107XHJcbiAgY29uc3QgY29udmVydGVkOiBJUmVwZWF0ZXJTdHJ1Y3R1cmVkW10gPSByYXdcclxuICAgIC5yZWR1Y2UoKG91dHB1dDogSVJlcGVhdGVyU3RydWN0dXJlZFtdLCBpbnB1dDogSVJlcGVhdGVyUmF3W10sIGluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgbG9nKFwiR290XCIsIGlucHV0Lmxlbmd0aCwgXCJyZXBlYXRlcnMgZnJvbSBmaWxlXCIsIGluZGV4ICsgMSk7XHJcbiAgICAgIHJldHVybiBbLi4ub3V0cHV0LCAuLi5pbnB1dC5tYXAoY29udmVydFJlcGVhdGVyKV07XHJcbiAgICB9LCBbXSlcclxuICAgIC5maWx0ZXIoKHJlcGVhdGVyOiBJUmVwZWF0ZXJTdHJ1Y3R1cmVkKSA9PiB7XHJcbiAgICAgIGlmIChpZHMuaW5jbHVkZXMocmVwZWF0ZXIuSUQpKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGlkcy5wdXNoKHJlcGVhdGVyLklEKTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgbG9nKFwiQ29udmVydGVkXCIsIGNvbnZlcnRlZC5sZW5ndGgsIFwicmVwZWF0ZXJzXCIpO1xyXG4gIGF3YWl0IHdyaXRlVG9Kc29uQW5kQ3N2KFwiLi4vZGF0YS9yZXBlYXRlcnMvY29udmVydGVkL0NPXCIsIGNvbnZlcnRlZCk7XHJcbn0pKCk7XHJcblxyXG5mdW5jdGlvbiBjb252ZXJ0UmVwZWF0ZXIocmF3OiBJUmVwZWF0ZXJSYXcpOiBJUmVwZWF0ZXJTdHJ1Y3R1cmVkIHtcclxuICByZXR1cm4ge1xyXG4gICAgSUQ6IGNvbnZlcnROdW1iZXIocmF3LklEKSBhcyBudW1iZXIsXHJcbiAgICBTdGF0ZUlEOiBjb252ZXJ0TnVtYmVyKHJhdy5zdGF0ZV9pZCkgYXMgbnVtYmVyLFxyXG4gICAgQ2FsbHNpZ246IHJhdy5DYWxsLFxyXG4gICAgTG9jYXRpb246IHtcclxuICAgICAgTGF0aXR1ZGU6IHJhdy5MYXRpdHVkZSxcclxuICAgICAgTG9uZ2l0dWRlOiByYXcuTG9uZ2l0dWRlLFxyXG4gICAgICBDb3VudHk6IHJhdy5Db3VudHksXHJcbiAgICAgIFN0YXRlOiByYXdbXCJTVC9QUlwiXSxcclxuICAgICAgTG9jYWw6IHJhdy5Mb2NhdGlvbixcclxuICAgIH0sXHJcbiAgICBVc2U6IGNvbnZlcnRSZXBlYXRlclVzZShyYXcuVXNlKSxcclxuICAgIFN0YXR1czogY29udmVydFJlcGVhdGVyU3RhdHVzKHJhd1tcIk9wIFN0YXR1c1wiXSksXHJcbiAgICBGcmVxdWVuY3k6IHsgSW5wdXQ6IGNvbnZlcnROdW1iZXIocmF3LlVwbGluaykgfHwgKHJhdy5Eb3dubGluayArIHJhdy5PZmZzZXQpLCBPdXRwdXQ6IHJhdy5Eb3dubGluayB9LFxyXG4gICAgU3F1ZWxjaFRvbmU6IGNvbnZlcnRSZXBlYXRlclNxdWVsY2hUb25lKHJhd1tcIlVwbGluayBUb25lXCJdLCByYXdbXCJEb3dubGluayBUb25lXCJdKSxcclxuICAgIERpZ2l0YWxUb25lOiBjb252ZXJ0UmVwZWF0ZXJEaWdpdGFsVG9uZShyYXdbXCJVcGxpbmsgVG9uZVwiXSwgcmF3W1wiRG93bmxpbmsgVG9uZVwiXSksXHJcbiAgICBEaWdpdGFsOiBjb252ZXJ0UmVwZWF0ZXJEaWdpdGFsRGF0YShyYXcpLFxyXG4gICAgVk9JUDogY29udmVydFJlcGVhdGVyVk9JUChyYXcpLFxyXG4gIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbnZlcnRSZXBlYXRlclVzZShyYXc6IHN0cmluZyk6IFJlcGVhdGVyVXNlIHtcclxuICBzd2l0Y2ggKHJhdy50b0xvd2VyQ2FzZSgpKSB7XHJcbiAgICBjYXNlIFwib3BlblwiOlxyXG4gICAgICByZXR1cm4gUmVwZWF0ZXJVc2UuT3BlbjtcclxuICAgIGNhc2UgXCJjbG9zZWRcIjpcclxuICAgICAgcmV0dXJuIFJlcGVhdGVyVXNlLkNsb3NlZDtcclxuICAgIGNhc2UgXCJwcml2YXRlXCI6XHJcbiAgICAgIHJldHVybiBSZXBlYXRlclVzZS5Qcml2YXRlO1xyXG4gICAgZGVmYXVsdDpcclxuICAgICAgcmV0dXJuIFJlcGVhdGVyVXNlLk90aGVyO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gY29udmVydFJlcGVhdGVyU3RhdHVzKHJhdzogc3RyaW5nIHwgdW5kZWZpbmVkKTogUmVwZWF0ZXJTdGF0dXMge1xyXG4gIGlmICghcmF3KSB7XHJcbiAgICByZXR1cm4gUmVwZWF0ZXJTdGF0dXMuT3RoZXI7XHJcbiAgfVxyXG4gIHN3aXRjaCAocmF3LnRvTG93ZXJDYXNlKCkpIHtcclxuICAgIGNhc2UgXCJvbi1haXJcIjpcclxuICAgICAgcmV0dXJuIFJlcGVhdGVyU3RhdHVzLk9uQWlyO1xyXG4gICAgY2FzZSBcIm9mZi1haXJcIjpcclxuICAgICAgcmV0dXJuIFJlcGVhdGVyU3RhdHVzLk9mZkFpcjtcclxuICAgIGNhc2UgXCJ0ZXN0aW5nXCI6XHJcbiAgICAgIHJldHVybiBSZXBlYXRlclN0YXR1cy5UZXN0aW5nO1xyXG4gICAgY2FzZSBcInVua25vd25cIjpcclxuICAgICAgcmV0dXJuIFJlcGVhdGVyU3RhdHVzLlVua25vd247XHJcbiAgICBkZWZhdWx0OlxyXG4gICAgICByZXR1cm4gUmVwZWF0ZXJTdGF0dXMuT3RoZXI7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjb252ZXJ0UmVwZWF0ZXJTcXVlbGNoVG9uZShyYXdJbnB1dDogc3RyaW5nIHwgbnVtYmVyIHwgdW5kZWZpbmVkLCByYXdPdXRwdXQ6IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCk6IHsgSW5wdXQ/OiBudW1iZXI7IE91dHB1dD86IG51bWJlciB9IHwgdW5kZWZpbmVkIHtcclxuICBpZiAoIXJhd0lucHV0ICYmICFyYXdPdXRwdXQpIHtcclxuICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgfVxyXG4gIGNvbnN0IGNvbnZlcnRlZDogeyBJbnB1dDogbnVtYmVyIHwgdW5kZWZpbmVkOyBPdXRwdXQ6IG51bWJlciB8IHVuZGVmaW5lZCB9ID0ge1xyXG4gICAgSW5wdXQ6IGNvbnZlcnROdW1iZXIocmF3SW5wdXQpLFxyXG4gICAgT3V0cHV0OiBjb252ZXJ0TnVtYmVyKHJhd091dHB1dCksXHJcbiAgfTtcclxuICBpZiAoY29udmVydGVkLklucHV0IHx8IGNvbnZlcnRlZC5PdXRwdXQpIHtcclxuICAgIHJldHVybiBjb252ZXJ0ZWQ7XHJcbiAgfVxyXG4gIHJldHVybiB1bmRlZmluZWQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbnZlcnRSZXBlYXRlckRpZ2l0YWxUb25lKHJhd0lucHV0OiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQsIHJhd091dHB1dDogc3RyaW5nIHwgbnVtYmVyIHwgdW5kZWZpbmVkKTogeyBJbnB1dD86IG51bWJlcjsgT3V0cHV0PzogbnVtYmVyIH0gfCB1bmRlZmluZWQge1xyXG4gIGlmICghcmF3SW5wdXQgJiYgIXJhd091dHB1dCkge1xyXG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuICB9XHJcbiAgY29uc3QgZGlnaXRhbEZpbHRlcjogUmVnRXhwID0gL15EKFxcZCspJC87XHJcbiAgY29uc3QgY29udmVydGVkOiB7IElucHV0OiBudW1iZXIgfCB1bmRlZmluZWQ7IE91dHB1dDogbnVtYmVyIHwgdW5kZWZpbmVkIH0gPSB7XHJcbiAgICBJbnB1dDogdHlwZW9mIHJhd0lucHV0ID09PSBcInN0cmluZ1wiID8gY29udmVydE51bWJlcihyYXdJbnB1dCwgZGlnaXRhbEZpbHRlcikgOiB1bmRlZmluZWQsXHJcbiAgICBPdXRwdXQ6IHR5cGVvZiByYXdPdXRwdXQgPT09IFwic3RyaW5nXCIgPyBjb252ZXJ0TnVtYmVyKHJhd091dHB1dCwgZGlnaXRhbEZpbHRlcikgOiB1bmRlZmluZWQsXHJcbiAgfTtcclxuICBpZiAoY29udmVydGVkLklucHV0IHx8IGNvbnZlcnRlZC5PdXRwdXQpIHtcclxuICAgIHJldHVybiBjb252ZXJ0ZWQ7XHJcbiAgfVxyXG4gIHJldHVybiB1bmRlZmluZWQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbnZlcnROdW1iZXIoaW5wdXQ6IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCwgbnVtYmVyRmlsdGVyOiBSZWdFeHAgPSAvXihbKy1dP1xcZCtcXC4/XFxkKikkLyk6IG51bWJlciB8IHVuZGVmaW5lZCB7XHJcbiAgaWYgKHR5cGVvZiBpbnB1dCA9PT0gXCJudW1iZXJcIiAmJiAhaXNOYU4oaW5wdXQpKSB7XHJcbiAgICByZXR1cm4gaW5wdXQ7XHJcbiAgfSBlbHNlIGlmICh0eXBlb2YgaW5wdXQgPT09IFwibnVtYmVyXCIgJiYgaXNOYU4oaW5wdXQpKSB7XHJcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gIH0gZWxzZSBpZiAodHlwZW9mIGlucHV0ID09PSBcInN0cmluZ1wiICYmIG51bWJlckZpbHRlci50ZXN0KGlucHV0KSkge1xyXG4gICAgY29uc3QgbWF0Y2g6IFJlZ0V4cE1hdGNoQXJyYXkgfCBudWxsID0gaW5wdXQubWF0Y2gobnVtYmVyRmlsdGVyKTtcclxuICAgIGlmIChtYXRjaCAmJiBtYXRjaFsxXSkge1xyXG4gICAgICBjb25zdCBjb252ZXJ0ZWQ6IG51bWJlciA9IHBhcnNlRmxvYXQobWF0Y2hbMV0pO1xyXG4gICAgICByZXR1cm4gIWlzTmFOKGNvbnZlcnRlZCkgPyBjb252ZXJ0ZWQgOiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjb252ZXJ0UmVwZWF0ZXJEaWdpdGFsRGF0YShyYXc6IElSZXBlYXRlclJhdyk6IElSZXBlYXRlckRpZ2l0YWxNb2RlcyB8IHVuZGVmaW5lZCB7XHJcbiAgY29uc3QgY29udmVydGVkOiBJUmVwZWF0ZXJEaWdpdGFsTW9kZXMgPSB7XHJcbiAgICAvLyBUT0RPOiBBVFY/OiBib29sZWFuO1xyXG4gICAgRE1SOiAocmF3LkRHVEwuaW5jbHVkZXMoXCJEXCIpIHx8IHJhd1tcIkRNUiBFbmFibGVkXCJdKSA/IHtcclxuICAgICAgQ29sb3JDb2RlOiBjb252ZXJ0TnVtYmVyKHJhd1tcIkNvbG9yIENvZGVcIl0pLFxyXG4gICAgICBJRDogY29udmVydE51bWJlcihyYXdbXCJETVIgSURcIl0pLFxyXG4gICAgfSA6IHVuZGVmaW5lZCxcclxuICAgIFAyNTogKHJhdy5ER1RMLmluY2x1ZGVzKFwiUFwiKSB8fCByYXdbXCJQLTI1IERpZ2l0YWwgRW5hYmxlZFwiXSkgPyB7IE5BQzogY29udmVydE51bWJlcihyYXcuTkFDKSB9IDogdW5kZWZpbmVkLFxyXG4gICAgRFN0YXI6IChyYXcuREdUTC5pbmNsdWRlcyhcIlNcIikgfHwgcmF3W1wiRC1TVEFSIEVuYWJsZWRcIl0pID8geyBOb2RlOiByYXcuTm9kZSB9IDogdW5kZWZpbmVkLFxyXG4gICAgWVNGOiAocmF3LkRHVEwuaW5jbHVkZXMoXCJZXCIpIHx8IHJhd1tcIllTRiBEaWdpdGFsIEVuYWJsZWRcIl0pID8ge1xyXG4gICAgICBHcm91cElEOiB7XHJcbiAgICAgICAgSW5wdXQ6IHR5cGVvZiByYXdbXCJERy1JRFwiXSA9PT0gXCJudW1iZXJcIiA/IHJhd1tcIkRHLUlEXCJdIDogdHlwZW9mIHJhd1tcIkRHLUlEXCJdID09PSBcInN0cmluZ1wiID8gcmF3W1wiREctSURcIl0uc3BsaXQoXCIvXCIpWzBdLnRyaW0oKSA6IHVuZGVmaW5lZCxcclxuICAgICAgICBPdXRwdXQ6IHR5cGVvZiByYXdbXCJERy1JRFwiXSA9PT0gXCJudW1iZXJcIiA/IHJhd1tcIkRHLUlEXCJdIDogdHlwZW9mIHJhd1tcIkRHLUlEXCJdID09PSBcInN0cmluZ1wiID8gcmF3W1wiREctSURcIl0uc3BsaXQoXCIvXCIpWzFdLnRyaW0oKSA6IHVuZGVmaW5lZCxcclxuICAgICAgfSxcclxuICAgIH0gOiB1bmRlZmluZWQsXHJcbiAgfTtcclxuICBpZiAoY29udmVydGVkLkRNUiB8fCBjb252ZXJ0ZWQuUDI1IHx8IGNvbnZlcnRlZC5EU3RhciB8fCBjb252ZXJ0ZWQuWVNGKSB7XHJcbiAgICByZXR1cm4gY29udmVydGVkO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gY29udmVydFJlcGVhdGVyVk9JUChyYXc6IElSZXBlYXRlclJhdyk6IElSZXBlYXRlclZPSVBNb2RlcyB8IHVuZGVmaW5lZCB7XHJcbiAgY29uc3QgY29udmVydGVkOiBJUmVwZWF0ZXJWT0lQTW9kZXMgPSB7XHJcbiAgICBBbGxTdGFyOiAocmF3LlZPSVAuaW5jbHVkZXMoXCJBXCIpIHx8IHJhdy5BbGxTdGFyKSA/IHsgTm9kZUlEOiBjb252ZXJ0TnVtYmVyKHJhdy5BbGxTdGFyKSB9IDogdW5kZWZpbmVkLFxyXG4gICAgRWNob0xpbms6IChyYXcuVk9JUC5pbmNsdWRlcyhcIkVcIikgfHwgcmF3LkVjaG9MaW5rKSA/IHtcclxuICAgICAgTm9kZUlEOiByYXcuRWNob0xpbmssXHJcbiAgICB9IDogdW5kZWZpbmVkLCAvLyBUT0RPOiBTdGF0dXM/OiBFY2hvTGlua05vZGVTdGF0dXNcclxuICAgIElSTFA6IChyYXcuVk9JUC5pbmNsdWRlcyhcIklcIikgfHwgcmF3LklSTFApID8geyBOb2RlSUQ6IGNvbnZlcnROdW1iZXIocmF3LklSTFApIH0gOiB1bmRlZmluZWQsXHJcbiAgICBXaXJlczogKHJhdy5WT0lQLmluY2x1ZGVzKFwiV1wiKSB8fCByYXdbXCJXSVJFUy1YXCJdKSA/IHsgSUQ6IGNvbnZlcnROdW1iZXIocmF3W1wiV0lSRVMtWFwiXSkgfSA6IHVuZGVmaW5lZCxcclxuICB9O1xyXG4gIGlmIChjb252ZXJ0ZWQuQWxsU3RhciB8fCBjb252ZXJ0ZWQuRWNob0xpbmsgfHwgY29udmVydGVkLklSTFAgfHwgY29udmVydGVkLldpcmVzKSB7XHJcbiAgICByZXR1cm4gY29udmVydGVkO1xyXG4gIH1cclxufVxyXG4iXX0=