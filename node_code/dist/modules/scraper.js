"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs_helpers_1 = require("@helpers/fs-helpers");
const helpers_1 = require("@helpers/helpers");
const log_helpers_1 = require("@helpers/log-helpers");
const axios_1 = __importDefault(require("axios"));
const chalk_1 = __importDefault(require("chalk"));
const jsdom_1 = require("jsdom");
const helper_1 = require("./helper");
const { log, write } = log_helpers_1.createOut("Scraper");
// const write = createWrite("Scraper");
class Scraper {
    constructor(location, distance) {
        this.location = location;
        this.distance = distance;
        this.data = [];
        log(chalk_1.default.green("New Scraper"), location, distance);
        this.url = `https://www.repeaterbook.com/repeaters/prox_result.php?city=${encodeURIComponent(location.toString())}&distance=${distance}&Dunit=m&band1=%25&band2=&freq=&call=&features%5B%5D=&status_id=%25&use=%25&order=distance_calc%2C+state_id%2C+%60call%60+ASC`;
    }
    async process() {
        log(chalk_1.default.green("Process"));
        const parts = this.location.toString().split(`,`);
        const baseKey = `${(parts[1] || ".").trim()}/${parts[0].trim()}.html`;
        const page = await this.getUrl(this.url, baseKey);
        const dom = new jsdom_1.JSDOM(page);
        await this.getRepeaterList(dom.window.document);
        return this.data;
    }
    async getRepeaterList(document) {
        log(chalk_1.default.green("Get Repeater List"));
        const table = document.querySelector("table.w3-table.w3-striped.w3-responsive");
        if (table) {
            const rows = [...table.querySelectorAll("tbody > tr")];
            const headerRow = rows.shift();
            if (headerRow) {
                const headerCells = [...headerRow.querySelectorAll("th")];
                const headers = headerCells.map((th) => helper_1.getText(th));
                for (const row of rows) {
                    const data = {};
                    const cells = [...row.querySelectorAll("td")];
                    cells.forEach((td, index) => data[headers[index]] = helper_1.getTextOrNumber(td));
                    const link = cells[0].querySelector("a");
                    if (link) {
                        write("^");
                        Object.assign(data, await this.getRepeaterDetails(link.href));
                        write("_");
                    }
                    this.data.push(data);
                }
            }
        }
    }
    async getRepeaterDetails(href) {
        const urlParams = href.split("?")[1];
        const keyParts = urlParams.match(/state_id=(\d+)&ID=(\d+)/) || [];
        const key = `${keyParts[1]}/${keyParts[2]}.html`;
        const page = await this.getUrl(`https://www.repeaterbook.com/repeaters/${href}`, key);
        const dom = new jsdom_1.JSDOM(page);
        const data = {};
        data.state_id = keyParts[1];
        data.ID = keyParts[2];
        const menus = [...dom.window.document.querySelectorAll("#cssmenu a")];
        const locationRegex = /(-?\d*\.?\d*)\+(-?\d*\.?\d*)/i;
        for (const menu of menus) {
            const locationMatch = menu.href.match(locationRegex);
            if (locationMatch) {
                const lat = helper_1.getNumber(locationMatch[1]);
                const long = helper_1.getNumber(locationMatch[2]);
                if (!isNaN(lat)) {
                    data.Latitude = lat;
                }
                if (!isNaN(long)) {
                    data.Longitude = long;
                }
                break;
            }
        }
        const table = dom.window.document.querySelector("table.w3-table.w3-responsive");
        if (table) {
            const rows = [...table.querySelectorAll("tbody > tr")];
            for (const row of rows) {
                const cells = [...row.querySelectorAll("td")];
                const title = helper_1.getText(cells[0]);
                const value = helper_1.getTextOrNumber(cells[1]);
                const dataKey = title.split(":")[0].trim();
                const dataVal = title.split(":")[1];
                let updated;
                if (dataVal) {
                    const date = dataVal.match(/(\d{4}-\d{2}-\d{2})/);
                    if (date && date[1]) {
                        updated = date[1];
                    }
                }
                data[dataKey] = updated || value;
            }
        }
        return data;
    }
    async getCache(key) {
        const file = `../data/repeaters/_cache/${key}`;
        if (await fs_helpers_1.dirExists(file)) {
            return (await fs_helpers_1.readFileAsync(file)).toString();
        }
    }
    async setCache(key, value) {
        const file = `../data/repeaters/_cache/${key}`;
        await fs_helpers_1.makeDirs(file);
        return fs_helpers_1.writeFileAsync(file, value);
    }
    async getUrl(url, cacheKey) {
        // log(chalk.green("Get URL"), url, cacheKey);
        const cache = await this.getCache(cacheKey || url);
        if (cache) {
            // log(chalk.yellow("Cached"), url, cacheKey);
            write("<");
            return cache;
        }
        else {
            // Slow down the requests a little bit so we"re not hammering the server or triggering any anti-bot or DDoS protections
            const waitTime = (5000 + (Math.random() * 10000));
            await helpers_1.wait(waitTime);
            // log(chalk.yellow("Get"), url);
            const request = await axios_1.default.get(url);
            // log(chalk.green("Got"), url);
            write(">");
            const data = request.data;
            await this.setCache(cacheKey || url, data);
            return data;
        }
    }
}
exports.default = Scraper;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NyYXBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2R1bGVzL3NjcmFwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxvREFBeUY7QUFDekYsOENBQXdDO0FBQ3hDLHNEQUFpRDtBQUVqRCxrREFBNkM7QUFDN0Msa0RBQTBCO0FBQzFCLGlDQUE4QjtBQUM5QixxQ0FBK0Q7QUFFL0QsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsR0FBcUUsdUJBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUM5Ryx3Q0FBd0M7QUFFeEMsTUFBcUIsT0FBTztJQUkxQixZQUFvQixRQUF5QixFQUFVLFFBQWdCO1FBQW5ELGFBQVEsR0FBUixRQUFRLENBQWlCO1FBQVUsYUFBUSxHQUFSLFFBQVEsQ0FBUTtRQUgvRCxTQUFJLEdBQW1CLEVBQUUsQ0FBQztRQUloQyxHQUFHLENBQUMsZUFBSyxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsRUFBRSxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLEdBQUcsR0FBRywrREFBK0Qsa0JBQWtCLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDLGFBQWEsUUFBUSwrSEFBK0gsQ0FBQztJQUN4USxDQUFDO0lBRU0sS0FBSyxDQUFDLE9BQU87UUFDbEIsR0FBRyxDQUFDLGVBQUssQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUU1QixNQUFNLEtBQUssR0FBYSxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM1RCxNQUFNLE9BQU8sR0FBVyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDO1FBQzlFLE1BQU0sSUFBSSxH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UUFDckIsT0FBTywyQkFBYyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBRU8sS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFXLEVBQUUsUUFBaUI7UUFDakQsOENBQThDO1FBRTlDLE1BQU0sS0FBSyxHQUF1QixNQUFNLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZFLElBQUksS0FBSyxFQUFFO1lBQ1QsOENBQThDO1lBQzlDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNYLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7YUFBTTtZQUNMLHVIQUF1SDtZQUN2SCxNQUFNLFFBQVEsR0FBVyxDQUFDLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDO1lBRTFELE1BQU0sY0FBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQ3JCLGlDQUFpQztZQUNqQyxNQUFNLE9BQU8sR0FBMEIsTUFBTSxlQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzVELGdDQUFnQztZQUNoQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFWCxNQUFNLElBQUksR0FBVyxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ2xDLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLElBQUksR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQzNDLE9BQU8sSUFBSSxDQUFDO1NBQ2I7SUFDSCxDQUFDO0NBQ0Y7QUFqSUQsMEJBaUlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZGlyRXhpc3RzLCBtYWtlRGlycywgcmVhZEZpbGVBc3luYywgd3JpdGVGaWxlQXN5bmMgfSBmcm9tIFwiQGhlbHBlcnMvZnMtaGVscGVyc1wiO1xyXG5pbXBvcnQgeyB3YWl0IH0gZnJvbSBcIkBoZWxwZXJzL2hlbHBlcnNcIjtcclxuaW1wb3J0IHsgY3JlYXRlT3V0IH0gZnJvbSBcIkBoZWxwZXJzL2xvZy1oZWxwZXJzXCI7XHJcbmltcG9ydCB7IElSZXBlYXRlclJhdyB9IGZyb20gXCJAaW50ZXJmYWNlcy9pLXJlcGVhdGVyLXJhd1wiO1xyXG5pbXBvcnQgQXhpb3MsIHsgQXhpb3NSZXNwb25zZSB9IGZyb20gXCJheGlvc1wiO1xyXG5pbXBvcnQgY2hhbGsgZnJvbSBcImNoYWxrXCI7XHJcbmltcG9ydCB7IEpTRE9NIH0gZnJvbSBcImpzZG9tXCI7XHJcbmltcG9ydCB7IGdldE51bWJlciwgZ2V0VGV4dCwgZ2V0VGV4dE9yTnVtYmVyIH0gZnJvbSBcIi4vaGVscGVyXCI7XHJcblxyXG5jb25zdCB7IGxvZywgd3JpdGUgfTogeyBsb2c6ICguLi5tc2c6IGFueVtdKSA9PiB2b2lkOyB3cml0ZTogKC4uLm1zZzogYW55W10pID0+IHZvaWQgfSA9IGNyZWF0ZU91dChcIlNjcmFwZXJcIik7XHJcbi8vIGNvbnN0IHdyaXRlID0gY3JlYXRlV3JpdGUoXCJTY3JhcGVyXCIpO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU2NyYXBlciB7XHJcbiAgcHJpdmF0ZSBkYXRhOiBJUmVwZWF0ZXJSYXdbXSA9IFtdO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgdXJsOiBzdHJpbmc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbG9jYXRpb246IHN0cmluZyB8IG51bWJlciwgcHJpdmF0ZSBkaXN0YW5jZTogbnVtYmVyKSB7XHJcbiAgICBsb2coY2hhbGsuZ3JlZW4oXCJOZXcgU2NyYXBlclwiKSwgbG9jYXRpb24sIGRpc3RhbmNlKTtcclxuICAgIHRoaXMudXJsID0gYGh0dHBzOi8vd3d3LnJlcGVhdGVyYm9vay5jb20vcmVwZWF0ZXJzL3Byb3hfcmVzdWx0LnBocD9jaXR5PSR7ZW5jb2RlVVJJQ29tcG9uZW50KGxvY2F0aW9uLnRvU3RyaW5nKCkpfSZkaXN0YW5jZT0ke2Rpc3RhbmNlfSZEdW5pdD1tJmJhbmQxPSUyNSZiYW5kMj0mZnJlcT0mY2FsbD0mZmVhdHVyZXMlNUIlNUQ9JnN0YXR1c19pZD0lMjUmdXNlPSUyNSZvcmRlcj1kaXN0YW5jZV9jYWxjJTJDK3N0YXRlX2lkJTJDKyU2MGNhbGwlNjArQVNDYDtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhc3luYyBwcm9jZXNzKCk6IFByb21pc2U8SVJlcGVhdGVyUmF3W10+IHtcclxuICAgIGxvZyhjaGFsay5ncmVlbihcIlByb2Nlc3NcIikpO1xyXG5cclxuICAgIGNvbnN0IHBhcnRzOiBzdHJpbmdbXSA9IHRoaXMubG9jYXRpb24udG9TdHJpbmcoKS5zcGxpdChgLGApO1xyXG4gICAgY29uc3QgYmFzZUtleTogc3RyaW5nID0gYCR7KHBhcnRzWzFdIHx8IFwiLlwiKS50cmltKCl9LyR7cGFydHNbMF0udHJpbSgpfS5odG1sYDtcclxuICAgIGNvbnN0IHBhZ2U6IHN0cmluZyA9IGF3YWl0IHRoaXMuZ2V0VXJsKHRoaXMudXJsLCBiYXNlS2V5KTtcclxuICAgIGNvbnN0IGRvbTogSlNET00gPSBuZXcgSlNET00ocGFnZSk7XHJcbiAgICBhd2FpdCB0aGlzLmdldFJlcGVhdGVyTGlzdChkb20ud2luZG93LmRvY3VtZW50KTtcclxuICAgIHJldHVybiB0aGlzLmRhdGE7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIGdldFJlcGVhdGVyTGlzdChkb2N1bWVudDogRG9jdW1lbnQpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIGxvZyhjaGFsay5ncmVlbihcIkdldCBSZXBlYXRlciBMaXN0XCIpKTtcclxuXHJcbiAgICBjb25zdCB0YWJsZTogSFRNTFRhYmxlRWxlbWVudCB8IG51bGwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKFwidGFibGUudzMtdGFibGUudzMtc3RyaXBlZC53My1yZXNwb25zaXZlXCIpO1xyXG4gICAgaWYgKHRhYmxlKSB7XHJcbiAgICAgIGNvbnN0IHJvd3M6IEhUTUxUYWJsZVJvd0VsZW1lbnRbXSA9IFsuLi50YWJsZS5xdWVyeVNlbGVjdG9yQWxsPEhUTUxUYWJsZVJvd0VsZW1lbnQ+KFwidGJvZHkgPiB0clwiKV07XHJcbiAgICAgIGNvbnN0IGhlYWRlclJvdzogYW55IHwgdW5kZWZpbmVkID0gcm93cy5zaGlmdCgpO1xyXG4gICAgICBpZiAoaGVhZGVyUm93KSB7XHJcbiAgICAgICAgY29uc3QgaGVhZGVyQ2VsbHM6IEhUTUxUYWJsZUhlYWRlckNlbGxFbGVtZW50W10gPSBbLi4uaGVhZGVyUm93LnF1ZXJ5U2VsZWN0b3JBbGwoXCJ0aFwiKV07XHJcbiAgICAgICAgY29uc3QgaGVhZGVyczogc3RyaW5nW10gPSBoZWFkZXJDZWxscy5tYXAoKHRoOiBIVE1MVGFibGVIZWFkZXJDZWxsRWxlbWVudCkgPT4gZ2V0VGV4dCh0aCkpO1xyXG4gICAgICAgIGZvciAoY29uc3Qgcm93IG9mIHJvd3MpIHtcclxuICAgICAgICAgIGNvbnN0IGRhdGE6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgbnVtYmVyIHwgdW5kZWZpbmVkIH0gPSB7fTtcclxuICAgICAgICAgIGNvbnN0IGNlbGxzOiBIVE1MVGFibGVEYXRhQ2VsbEVsZW1lbnRbXSA9IFsuLi5yb3cucXVlcnlTZWxlY3RvckFsbChcInRkXCIpXTtcclxuICAgICAgICAgIGNlbGxzLmZvckVhY2goKHRkOiBIVE1MVGFibGVEYXRhQ2VsbEVsZW1lbnQsIGluZGV4OiBudW1iZXIpID0+IGRhdGFbaGVhZGVyc1tpbmRleF1dID0gZ2V0VGV4dE9yTnVtYmVyKHRkKSk7XHJcbiAgICAgICAgICBjb25zdCBsaW5rOiBIVE1MQW5jaG9yRWxlbWVudCB8IG51bGwgPSBjZWxsc1swXS5xdWVyeVNlbGVjdG9yKFwiYVwiKTtcclxuICAgICAgICAgIGlmIChsaW5rKSB7XHJcbiAgICAgICAgICAgIHdyaXRlKFwiXlwiKTtcclxuICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihkYXRhLCBhd2FpdCB0aGlzLmdldFJlcGVhdGVyRGV0YWlscyhsaW5rLmhyZWYpKTtcclxuICAgICAgICAgICAgd3JpdGUoXCJfXCIpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgdGhpcy5kYXRhLnB1c2goZGF0YSBhcyBhbnkgYXMgSVJlcGVhdGVyUmF3KTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgZ2V0UmVwZWF0ZXJEZXRhaWxzKGhyZWY6IHN0cmluZyk6IFByb21pc2U8SVJlcGVhdGVyUmF3PiB7XHJcbiAgICBjb25zdCB1cmxQYXJhbXM6IHN0cmluZyA9IGhyZWYuc3BsaXQoXCI/XCIpWzFdO1xyXG4gICAgY29uc3Qga2V5UGFydHM6IFJlZ0V4cE1hdGNoQXJyYXkgPSB1cmxQYXJhbXMubWF0Y2goL3N0YXRlX2lkPShcXGQrKSZJRD0oXFxkKykvKSB8fCBbXTtcclxuICAgIGNvbnN0IGtleTogc3RyaW5nID0gYCR7a2V5UGFydHNbMV19LyR7a2V5UGFydHNbMl19Lmh0bWxgO1xyXG4gICAgY29uc3QgcGFnZTogc3RyaW5nID0gYXdhaXQgdGhpcy5nZXRVcmwoYGh0dHBzOi8vd3d3LnJlcGVhdGVyYm9vay5jb20vcmVwZWF0ZXJzLyR7aHJlZn1gLCBrZXkpO1xyXG4gICAgY29uc3QgZG9tOiBKU0RPTSA9IG5ldyBKU0RPTShwYWdlKTtcclxuICAgIGNvbnN0IGRhdGE6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgbnVtYmVyIHwgdW5kZWZpbmVkIH0gPSB7fTtcclxuICAgIGRhdGEuc3RhdGVfaWQgPSBrZXlQYXJ0c1sxXTtcclxuICAgIGRhdGEuSUQgPSBrZXlQYXJ0c1syXTtcclxuICAgIGNvbnN0IG1lbnVzOiBIVE1MQW5jaG9yRWxlbWVudFtdID0gWy4uLmRvbS53aW5kb3cuZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbDxIVE1MQW5jaG9yRWxlbWVudD4oXCIjY3NzbWVudSBhXCIpXTtcclxuICAgIGNvbnN0IGxvY2F0aW9uUmVnZXg6IFJlZ0V4cCA9IC8oLT9cXGQqXFwuP1xcZCopXFwrKC0/XFxkKlxcLj9cXGQqKS9pO1xyXG4gICAgZm9yIChjb25zdCBtZW51IG9mIG1lbnVzKSB7XHJcbiAgICAgIGNvbnN0IGxvY2F0aW9uTWF0Y2g6IFJlZ0V4cE1hdGNoQXJyYXkgfCBudWxsID0gbWVudS5ocmVmLm1hdGNoKGxvY2F0aW9uUmVnZXgpO1xyXG4gICAgICBpZiAobG9jYXRpb25NYXRjaCkge1xyXG4gICAgICAgIGNvbnN0IGxhdDogbnVtYmVyID0gZ2V0TnVtYmVyKGxvY2F0aW9uTWF0Y2hbMV0pO1xyXG4gICAgICAgIGNvbnN0IGxvbmc6IG51bWJlciA9IGdldE51bWJlcihsb2NhdGlvbk1hdGNoWzJdKTtcclxuICAgICAgICBpZiAoIWlzTmFOKGxhdCkpIHtcclxuICAgICAgICAgIGRhdGEuTGF0aXR1ZGUgPSBsYXQ7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghaXNOYU4obG9uZykpIHtcclxuICAgICAgICAgIGRhdGEuTG9uZ2l0dWRlID0gbG9uZztcclxuICAgICAgICB9XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGNvbnN0IHRhYmxlOiBFbGVtZW50IHwgbnVsbCA9IGRvbS53aW5kb3cuZG9jdW1lbnQucXVlcnlTZWxlY3RvcihcInRhYmxlLnczLXRhYmxlLnczLXJlc3BvbnNpdmVcIik7XHJcbiAgICBpZiAodGFibGUpIHtcclxuICAgICAgY29uc3Qgcm93czogSFRNTFRhYmxlUm93RWxlbWVudFtdID0gWy4uLnRhYmxlLnF1ZXJ5U2VsZWN0b3JBbGw8SFRNTFRhYmxlUm93RWxlbWVudD4oXCJ0Ym9keSA+IHRyXCIpXTtcclxuICAgICAgZm9yIChjb25zdCByb3cgb2Ygcm93cykge1xyXG4gICAgICAgIGNvbnN0IGNlbGxzOiBIVE1MVGFibGVEYXRhQ2VsbEVsZW1lbnRbXSA9IFsuLi5yb3cucXVlcnlTZWxlY3RvckFsbChcInRkXCIpXTtcclxuICAgICAgICBjb25zdCB0aXRsZTogc3RyaW5nID0gZ2V0VGV4dChjZWxsc1swXSk7XHJcbiAgICAgICAgY29uc3QgdmFsdWU6IG51bWJlciB8IHN0cmluZyA9IGdldFRleHRPck51bWJlcihjZWxsc1sxXSk7XHJcbiAgICAgICAgY29uc3QgZGF0YUtleTogc3RyaW5nID0gdGl0bGUuc3BsaXQoXCI6XCIpWzBdLnRyaW0oKTtcclxuICAgICAgICBjb25zdCBkYXRhVmFsOiBzdHJpbmcgPSB0aXRsZS5zcGxpdChcIjpcIilbMV07XHJcbiAgICAgICAgbGV0IHVwZGF0ZWQ6IG51bWJlciB8IHN0cmluZyB8IHVuZGVmaW5lZDtcclxuICAgICAgICBpZiAoZGF0YVZhbCkge1xyXG4gICAgICAgICAgY29uc3QgZGF0ZTogUmVnRXhwTWF0Y2hBcnJheSB8IG51bGwgPSBkYXRhVmFsLm1hdGNoKC8oXFxkezR9LVxcZHsyfS1cXGR7Mn0pLyk7XHJcbiAgICAgICAgICBpZiAoZGF0ZSAmJiBkYXRlWzFdKSB7XHJcbiAgICAgICAgICAgIHVwZGF0ZWQgPSBkYXRlWzFdO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBkYXRhW2RhdGFLZXldID0gdXBkYXRlZCB8fCB2YWx1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGRhdGEgYXMgYW55IGFzIElSZXBlYXRlclJhdztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXN5bmMgZ2V0Q2FjaGUoa2V5OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4ge1xyXG4gICAgY29uc3QgZmlsZTogc3RyaW5nID0gYC4uL2RhdGEvcmVwZWF0ZXJzL19jYWNoZS8ke2tleX1gO1xyXG4gICAgaWYgKGF3YWl0IGRpckV4aXN0cyhmaWxlKSkge1xyXG4gICAgICByZXR1cm4gKGF3YWl0IHJlYWRGaWxlQXN5bmMoZmlsZSkpLnRvU3RyaW5nKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIHNldENhY2hlKGtleTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICBjb25zdCBmaWxlOiBzdHJpbmcgPSBgLi4vZGF0YS9yZXBlYXRlcnMvX2NhY2hlLyR7a2V5fWA7XHJcbiAgICBhd2FpdCBtYWtlRGlycyhmaWxlKTtcclxuICAgIHJldHVybiB3cml0ZUZpbGVBc3luYyhmaWxlLCB2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIGdldFVybCh1cmw6IHN0cmluZywgY2FjaGVLZXk/OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgLy8gbG9nKGNoYWxrLmdyZWVuKFwiR2V0IFVSTFwiKSwgdXJsLCBjYWNoZUtleSk7XHJcblxyXG4gICAgY29uc3QgY2FjaGU6IHN0cmluZyB8IHVuZGVmaW5lZCA9IGF3YWl0IHRoaXMuZ2V0Q2FjaGUoY2FjaGVLZXkgfHwgdXJsKTtcclxuICAgIGlmIChjYWNoZSkge1xyXG4gICAgICAvLyBsb2coY2hhbGsueWVsbG93KFwiQ2FjaGVkXCIpLCB1cmwsIGNhY2hlS2V5KTtcclxuICAgICAgd3JpdGUoXCI8XCIpO1xyXG4gICAgICByZXR1cm4gY2FjaGU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAvLyBTbG93IGRvd24gdGhlIHJlcXVlc3RzIGEgbGl0dGxlIGJpdCBzbyB3ZVwicmUgbm90IGhhbW1lcmluZyB0aGUgc2VydmVyIG9yIHRyaWdnZXJpbmcgYW55IGFudGktYm90IG9yIEREb1MgcHJvdGVjdGlvbnNcclxuICAgICAgY29uc3Qgd2FpdFRpbWU6IG51bWJlciA9ICg1MDAwICsgKE1hdGgucmFuZG9tKCkgKiAxMDAwMCkpO1xyXG5cclxuICAgICAgYXdhaXQgd2FpdCh3YWl0VGltZSk7XHJcbiAgICAgIC8vIGxvZyhjaGFsay55ZWxsb3coXCJHZXRcIiksIHVybCk7XHJcbiAgICAgIGNvbnN0IHJlcXVlc3Q6IEF4aW9zUmVzcG9uc2U8c3RyaW5nPiA9IGF3YWl0IEF4aW9zLmdldCh1cmwpO1xyXG4gICAgICAvLyBsb2coY2hhbGsuZ3JlZW4oXCJHb3RcIiksIHVybCk7XHJcbiAgICAgIHdyaXRlKFwiPlwiKTtcclxuXHJcbiAgICAgIGNvbnN0IGRhdGE6IHN0cmluZyA9IHJlcXVlc3QuZGF0YTtcclxuICAgICAgYXdhaXQgdGhpcy5zZXRDYWNoZShjYWNoZUtleSB8fCB1cmwsIGRhdGEpO1xyXG4gICAgICByZXR1cm4gZGF0YTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19