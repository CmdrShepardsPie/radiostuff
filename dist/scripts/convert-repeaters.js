(function (factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
        var v = factory(require, exports);
        if (v !== undefined) module.exports = v;
    }
    else if (typeof define === "function" && define.amd) {
        define(["require", "exports", "module-alias/register", "@helpers/fs-helpers", "@helpers/log-helpers", "@interfaces/i-repeater-structured"], factory);
    }
})(function (require, exports) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    require("module-alias/register");
    const fs_helpers_1 = require("@helpers/fs-helpers");
    const log_helpers_1 = require("@helpers/log-helpers");
    const i_repeater_structured_1 = require("@interfaces/i-repeater-structured");
    const log = log_helpers_1.createLog('Convert Repeaters');
    exports.default = (async () => {
        const raw = await fs_helpers_1.getAllFilesFromDirectory('data/repeaters/results/CO');
        log('Got', raw.length, 'files');
        const ids = [];
        const converted = raw
            .reduce((output, input, index) => {
            log('Got', input.length, 'repeaters from file', index + 1);
            return [...output, ...input.map(convertRepeater)];
        }, [])
            .filter((repeater) => {
            if (ids.includes(repeater.ID)) {
                return false;
            }
            else {
                ids.push(repeater.ID);
                return true;
            }
        });
        log('Converted', converted.length, 'repeaters');
        await fs_helpers_1.writeToJsonAndCsv('data/repeaters/converted/CO', converted);
    })();
    function convertRepeater(raw) {
        return {
            ID: convertNumber(raw.ID),
            StateID: convertNumber(raw.state_id),
            Callsign: raw.Call,
            Location: { Latitude: raw.Latitude, Longitude: raw.Longitude, County: raw.County, State: raw['ST/PR'], Local: raw.Location },
            Use: convertRepeaterUse(raw.Use),
            Status: convertRepeaterStatus(raw['Op Status']),
            Frequency: { Input: convertNumber(raw.Uplink) || (raw.Downlink + raw.Offset), Output: raw.Downlink },
            SquelchTone: convertRepeaterSquelchTone(raw['Uplink Tone'], raw['Downlink Tone']),
            DigitalTone: convertRepeaterDigitalTone(raw['Uplink Tone'], raw['Downlink Tone']),
            Digital: convertRepeaterDigitalData(raw),
            VOIP: convertRepeaterVOIP(raw),
        };
    }
    function convertRepeaterUse(raw) {
        switch (raw.toLowerCase()) {
            case 'open':
                return i_repeater_structured_1.RepeaterUse.Open;
            case 'closed':
                return i_repeater_structured_1.RepeaterUse.Closed;
            case 'private':
                return i_repeater_structured_1.RepeaterUse.Private;
            default:
                return i_repeater_structured_1.RepeaterUse.Other;
        }
    }
    function convertRepeaterStatus(raw) {
        if (!raw) {
            return i_repeater_structured_1.RepeaterStatus.Other;
        }
        switch (raw.toLowerCase()) {
            case 'on-air':
                return i_repeater_structured_1.RepeaterStatus.OnAir;
            case 'off-air':
                return i_repeater_structured_1.RepeaterStatus.OffAir;
            case 'testing':
                return i_repeater_structured_1.RepeaterStatus.Testing;
            case 'unknown':
                return i_repeater_structured_1.RepeaterStatus.Unknown;
            default:
                return i_repeater_structured_1.RepeaterStatus.Other;
        }
    }
    function convertRepeaterSquelchTone(rawInput, rawOutput) {
        if (!rawInput && !rawOutput) {
            return undefined;
        }
        const converted = {
            Input: convertNumber(rawInput),
            Output: convertNumber(rawOutput),
        };
        if (converted.Input || converted.Output) {
            return converted;
        }
        return undefined;
    }
    function convertRepeaterDigitalTone(rawInput, rawOutput) {
        if (!rawInput && !rawOutput) {
            return undefined;
        }
        const digitalFilter = /^D(\d+)$/;
        const converted = {
            Input: typeof rawInput === 'string' ? convertNumber(rawInput, digitalFilter) : undefined,
            Output: typeof rawOutput === 'string' ? convertNumber(rawOutput, digitalFilter) : undefined,
        };
        if (converted.Input || converted.Output) {
            return converted;
        }
        return undefined;
    }
    function convertNumber(input, numberFilter = /^([+-]?\d+\.?\d*)$/) {
        if (typeof input === 'number' && !isNaN(input)) {
            return input;
        }
        else if (typeof input === 'number' && isNaN(input)) {
            return undefined;
        }
        else if (typeof input === 'string' && numberFilter.test(input)) {
            const match = input.match(numberFilter);
            if (match && match[1]) {
                const converted = parseFloat(match[1]);
                return !isNaN(converted) ? converted : undefined;
            }
        }
    }
    function convertRepeaterDigitalData(raw) {
        const converted = {
            // TODO: ATV?: boolean;
            DMR: (raw.DGTL.includes('D') || raw['DMR Enabled']) ? { ColorCode: convertNumber(raw['Color Code']), ID: convertNumber(raw['DMR ID']) } : undefined,
            P25: (raw.DGTL.includes('P') || raw['P-25 Digital Enabled']) ? { NAC: convertNumber(raw.NAC) } : undefined,
            DStar: (raw.DGTL.includes('S') || raw['D-STAR Enabled']) ? { Node: raw.Node } : undefined,
            YSF: (raw.DGTL.includes('Y') || raw['YSF Digital Enabled']) ? {
                GroupID: {
                    Input: typeof raw['DG-ID'] === 'number' ? raw['DG-ID'] : typeof raw['DG-ID'] === 'string' ? raw['DG-ID'].split('/')[0].trim() : undefined,
                    Output: typeof raw['DG-ID'] === 'number' ? raw['DG-ID'] : typeof raw['DG-ID'] === 'string' ? raw['DG-ID'].split('/')[1].trim() : undefined,
                },
            } : undefined,
        };
        if (converted.DMR || converted.P25 || converted.DStar || converted.YSF) {
            return converted;
        }
    }
    function convertRepeaterVOIP(raw) {
        const converted = {
            AllStar: (raw.VOIP.includes('A') || raw.AllStar) ? { NodeID: convertNumber(raw.AllStar) } : undefined,
            EchoLink: (raw.VOIP.includes('E') || raw.EchoLink) ? {
                NodeID: raw.EchoLink,
            } : undefined,
            IRLP: (raw.VOIP.includes('I') || raw.IRLP) ? { NodeID: convertNumber(raw.IRLP) } : undefined,
            Wires: (raw.VOIP.includes('W') || raw['WIRES-X']) ? { ID: convertNumber(raw['WIRES-X']) } : undefined,
        };
        if (converted.AllStar || converted.EchoLink || converted.IRLP || converted.Wires) {
            return converted;
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udmVydC1yZXBlYXRlcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2NyaXB0cy9jb252ZXJ0LXJlcGVhdGVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztJQUFBLGlDQUErQjtJQUUvQixvREFBa0Y7SUFDbEYsc0RBQWlEO0lBRWpELDZFQU0yQztJQUUzQyxNQUFNLEdBQUcsR0FBNEIsdUJBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBRXBFLGtCQUFlLENBQUMsS0FBSyxJQUFtQixFQUFFO1FBQ3hDLE1BQU0sR0FBRyxHQUFxQixNQUFNLHFDQUF3QixDQUFDLDJCQUEyQixDQUFDLENBQUM7UUFDMUYsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ2hDLE1BQU0sR0FBRyxHQUFhLEVBQUUsQ0FBQztRQUN6QixNQUFNLFNBQVMsR0FBMEIsR0FBRzthQUN6QyxNQUFNLENBQUMsQ0FBQyxNQUE2QixFQUFFLEtBQXFCLEVBQUUsS0FBYSxFQUFFLEVBQUU7WUFDOUUsR0FBRyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsTUFBTSxFQUFFLHFCQUFxQixFQUFFLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMzRCxPQUFPLENBQUMsR0FBRyxNQUFNLEVBQUUsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7UUFDcEQsQ0FBQyxFQUFFLEVBQUUsQ0FBQzthQUNMLE1BQU0sQ0FBQyxDQUFDLFFBQTZCLEVBQUUsRUFBRTtZQUN4QyxJQUFJLEdBQUcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxFQUFFO2dCQUM3QixPQUFPLEtBQUssQ0FBQzthQUNkO2lCQUFNO2dCQUNMLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUN0QixPQUFPLElBQUksQ0FBQzthQUNi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QVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUztZQUNyRyxRQUFRLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNuRCxNQUFNLEVBQUUsR0FBRyxDQUFDLFFBQVE7YUFDckIsQ0FBQyxDQUFDLENBQUMsU0FBUztZQUNiLElBQUksRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTO1lBQzVGLEtBQUssRUFBRSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxhQUFhLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUztTQUN0RyxDQUFDO1FBQ0YsSUFBSSxTQUFTLENBQUMsT0FBTyxJQUFJLFNBQVMsQ0FBQyxRQUFRLElBQUksU0FBUyxDQUFDLElBQUksSUFBSSxTQUFTLENBQUMsS0FBSyxFQUFFO1lBQ2hGLE9BQU8sU0FBUyxDQUFDO1NBQ2xCO0lBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnbW9kdWxlLWFsaWFzL3JlZ2lzdGVyJztcblxuaW1wb3J0IHsgZ2V0QWxsRmlsZXNGcm9tRGlyZWN0b3J5LCB3cml0ZVRvSnNvbkFuZENzdiB9IGZyb20gJ0BoZWxwZXJzL2ZzLWhlbHBlcnMnO1xuaW1wb3J0IHsgY3JlYXRlTG9nIH0gZnJvbSAnQGhlbHBlcnMvbG9nLWhlbHBlcnMnO1xuaW1wb3J0IHsgSVJlcGVhdGVyUmF3IH0gZnJvbSAnQGludGVyZmFjZXMvaS1yZXBlYXRlci1yYXcnO1xuaW1wb3J0IHtcbiAgSVJlcGVhdGVyRGlnaXRhbE1vZGVzLFxuICBJUmVwZWF0ZXJTdHJ1Y3R1cmVkLFxuICBJUmVwZWF0ZXJWT0lQTW9kZXMsXG4gIFJlcGVhdGVyU3RhdHVzLFxuICBSZXBlYXRlclVzZSxcbn0gZnJvbSAnQGludGVyZmFjZXMvaS1yZXBlYXRlci1zdHJ1Y3R1cmVkJztcblxuY29uc3QgbG9nOiAoLi4ubXNnOiBhbnlbXSkgPT4gdm9pZCA9IGNyZWF0ZUxvZygnQ29udmVydCBSZXBlYXRlcnMnKTtcblxuZXhwb3J0IGRlZmF1bHQgKGFzeW5jICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgY29uc3QgcmF3OiBJUmVwZWF0ZXJSYXdbXVtdID0gYXdhaXQgZ2V0QWxsRmlsZXNGcm9tRGlyZWN0b3J5KCdkYXRhL3JlcGVhdGVycy9yZXN1bHRzL0NPJyk7XG4gIGxvZygnR290JywgcmF3Lmxlbmd0aCwgJ2ZpbGVzJyk7XG4gIGNvbnN0IGlkczogbnVtYmVyW10gPSBbXTtcbiAgY29uc3QgY29udmVydGVkOiBJUmVwZWF0ZXJTdHJ1Y3R1cmVkW10gPSByYXdcbiAgICAucmVkdWNlKChvdXRwdXQ6IElSZXBlYXRlclN0cnVjdHVyZWRbXSwgaW5wdXQ6IElSZXBlYXRlclJhd1tdLCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICBsb2coJ0dvdCcsIGlucHV0Lmxlbmd0aCwgJ3JlcGVhdGVycyBmcm9tIGZpbGUnLCBpbmRleCArIDEpO1xuICAgICAgcmV0dXJuIFsuLi5vdXRwdXQsIC4uLmlucHV0Lm1hcChjb252ZXJ0UmVwZWF0ZXIpXTtcbiAgICB9LCBbXSlcbiAgICAuZmlsdGVyKChyZXBlYXRlcjogSVJlcGVhdGVyU3RydWN0dXJlZCkgPT4ge1xuICAgICAgaWYgKGlkcy5pbmNsdWRlcyhyZXBlYXRlci5JRCkpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWRzLnB1c2gocmVwZWF0ZXIuSUQpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgbG9nKCdDb252ZXJ0ZWQnLCBjb252ZXJ0ZWQubGVuZ3RoLCAncmVwZWF0ZXJzJyk7XG4gIGF3YWl0IHdyaXRlVG9Kc29uQW5kQ3N2KCdkYXRhL3JlcGVhdGVycy9jb252ZXJ0ZWQvQ08nLCBjb252ZXJ0ZWQpO1xufSkoKTtcblxuZnVuY3Rpb24gY29udmVydFJlcGVhdGVyKHJhdzogSVJlcGVhdGVyUmF3KTogSVJlcGVhdGVyU3RydWN0dXJlZCB7XG4gIHJldHVybiB7XG4gICAgSUQ6IGNvbnZlcnROdW1iZXIocmF3LklEKSBhcyBudW1iZXIsXG4gICAgU3RhdGVJRDogY29udmVydE51bWJlcihyYXcuc3RhdGVfaWQpIGFzIG51bWJlcixcbiAgICBDYWxsc2lnbjogcmF3LkNhbGwsXG4gICAgTG9jYXRpb246IHsgTGF0aXR1ZGU6IHJhdy5MYXRpdHVkZSwgTG9uZ2l0dWRlOiByYXcuTG9uZ2l0dWRlLCBDb3VudHk6IHJhdy5Db3VudHksIFN0YXRlOiByYXdbJ1NUL1BSJ10sIExvY2FsOiByYXcuTG9jYXRpb24gfSxcbiAgICBVc2U6IGNvbnZlcnRSZXBlYXRlclVzZShyYXcuVXNlKSxcbiAgICBTdGF0dXM6IGNvbnZlcnRSZXBlYXRlclN0YXR1cyhyYXdbJ09wIFN0YXR1cyddKSxcbiAgICBGcmVxdWVuY3k6IHsgSW5wdXQ6IGNvbnZlcnROdW1iZXIocmF3LlVwbGluaykgfHwgKHJhdy5Eb3dubGluayArIHJhdy5PZmZzZXQpLCBPdXRwdXQ6IHJhdy5Eb3dubGluayB9LFxuICAgIFNxdWVsY2hUb25lOiBjb252ZXJ0UmVwZWF0ZXJTcXVlbGNoVG9uZShyYXdbJ1VwbGluayBUb25lJ10sIHJhd1snRG93bmxpbmsgVG9uZSddKSxcbiAgICBEaWdpdGFsVG9uZTogY29udmVydFJlcGVhdGVyRGlnaXRhbFRvbmUocmF3WydVcGxpbmsgVG9uZSddLCByYXdbJ0Rvd25saW5rIFRvbmUnXSksXG4gICAgRGlnaXRhbDogY29udmVydFJlcGVhdGVyRGlnaXRhbERhdGEocmF3KSxcbiAgICBWT0lQOiBjb252ZXJ0UmVwZWF0ZXJWT0lQKHJhdyksXG4gIH07XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRSZXBlYXRlclVzZShyYXc6IHN0cmluZyk6IFJlcGVhdGVyVXNlIHtcbiAgc3dpdGNoIChyYXcudG9Mb3dlckNhc2UoKSkge1xuICAgIGNhc2UgJ29wZW4nOlxuICAgICAgcmV0dXJuIFJlcGVhdGVyVXNlLk9wZW47XG4gICAgY2FzZSAnY2xvc2VkJzpcbiAgICAgIHJldHVybiBSZXBlYXRlclVzZS5DbG9zZWQ7XG4gICAgY2FzZSAncHJpdmF0ZSc6XG4gICAgICByZXR1cm4gUmVwZWF0ZXJVc2UuUHJpdmF0ZTtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIFJlcGVhdGVyVXNlLk90aGVyO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRSZXBlYXRlclN0YXR1cyhyYXc6IHN0cmluZyB8IHVuZGVmaW5lZCk6IFJlcGVhdGVyU3RhdHVzIHtcbiAgaWYgKCFyYXcpIHtcbiAgICByZXR1cm4gUmVwZWF0ZXJTdGF0dXMuT3RoZXI7XG4gIH1cbiAgc3dpdGNoIChyYXcudG9Mb3dlckNhc2UoKSkge1xuICAgIGNhc2UgJ29uLWFpcic6XG4gICAgICByZXR1cm4gUmVwZWF0ZXJTdGF0dXMuT25BaXI7XG4gICAgY2FzZSAnb2ZmLWFpcic6XG4gICAgICByZXR1cm4gUmVwZWF0ZXJTdGF0dXMuT2ZmQWlyO1xuICAgIGNhc2UgJ3Rlc3RpbmcnOlxuICAgICAgcmV0dXJuIFJlcGVhdGVyU3RhdHVzLlRlc3Rpbmc7XG4gICAgY2FzZSAndW5rbm93bic6XG4gICAgICByZXR1cm4gUmVwZWF0ZXJTdGF0dXMuVW5rbm93bjtcbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIFJlcGVhdGVyU3RhdHVzLk90aGVyO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRSZXBlYXRlclNxdWVsY2hUb25lKHJhd0lucHV0OiBzdHJpbmcgfCBudW1iZXIgfCB1bmRlZmluZWQsIHJhd091dHB1dDogc3RyaW5nIHwgbnVtYmVyIHwgdW5kZWZpbmVkKTogeyBJbnB1dD86IG51bWJlcjsgT3V0cHV0PzogbnVtYmVyIH0gfCB1bmRlZmluZWQge1xuICBpZiAoIXJhd0lucHV0ICYmICFyYXdPdXRwdXQpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG4gIGNvbnN0IGNvbnZlcnRlZDogeyBJbnB1dDogbnVtYmVyIHwgdW5kZWZpbmVkOyBPdXRwdXQ6IG51bWJlciB8IHVuZGVmaW5lZCB9ID0ge1xuICAgIElucHV0OiBjb252ZXJ0TnVtYmVyKHJhd0lucHV0KSxcbiAgICBPdXRwdXQ6IGNvbnZlcnROdW1iZXIocmF3T3V0cHV0KSxcbiAgfTtcbiAgaWYgKGNvbnZlcnRlZC5JbnB1dCB8fCBjb252ZXJ0ZWQuT3V0cHV0KSB7XG4gICAgcmV0dXJuIGNvbnZlcnRlZDtcbiAgfVxuICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0UmVwZWF0ZXJEaWdpdGFsVG9uZShyYXdJbnB1dDogc3RyaW5nIHwgbnVtYmVyIHwgdW5kZWZpbmVkLCByYXdPdXRwdXQ6IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCk6IHsgSW5wdXQ/OiBudW1iZXI7IE91dHB1dD86IG51bWJlciB9IHwgdW5kZWZpbmVkIHtcbiAgaWYgKCFyYXdJbnB1dCAmJiAhcmF3T3V0cHV0KSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBjb25zdCBkaWdpdGFsRmlsdGVyOiBSZWdFeHAgPSAvXkQoXFxkKykkLztcbiAgY29uc3QgY29udmVydGVkOiB7IElucHV0OiBudW1iZXIgfCB1bmRlZmluZWQ7IE91dHB1dDogbnVtYmVyIHwgdW5kZWZpbmVkIH0gPSB7XG4gICAgSW5wdXQ6IHR5cGVvZiByYXdJbnB1dCA9PT0gJ3N0cmluZycgPyBjb252ZXJ0TnVtYmVyKHJhd0lucHV0LCBkaWdpdGFsRmlsdGVyKSA6IHVuZGVmaW5lZCxcbiAgICBPdXRwdXQ6IHR5cGVvZiByYXdPdXRwdXQgPT09ICdzdHJpbmcnID8gY29udmVydE51bWJlcihyYXdPdXRwdXQsIGRpZ2l0YWxGaWx0ZXIpIDogdW5kZWZpbmVkLFxuICB9O1xuICBpZiAoY29udmVydGVkLklucHV0IHx8IGNvbnZlcnRlZC5PdXRwdXQpIHtcbiAgICByZXR1cm4gY29udmVydGVkO1xuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnROdW1iZXIoaW5wdXQ6IHN0cmluZyB8IG51bWJlciB8IHVuZGVmaW5lZCwgbnVtYmVyRmlsdGVyOiBSZWdFeHAgPSAvXihbKy1dP1xcZCtcXC4/XFxkKikkLyk6IG51bWJlciB8IHVuZGVmaW5lZCB7XG4gIGlmICh0eXBlb2YgaW5wdXQgPT09ICdudW1iZXInICYmICFpc05hTihpbnB1dCkpIHtcbiAgICByZXR1cm4gaW5wdXQ7XG4gIH0gZWxzZSBpZiAodHlwZW9mIGlucHV0ID09PSAnbnVtYmVyJyAmJiBpc05hTihpbnB1dCkpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9IGVsc2UgaWYgKHR5cGVvZiBpbnB1dCA9PT0gJ3N0cmluZycgJiYgbnVtYmVyRmlsdGVyLnRlc3QoaW5wdXQpKSB7XG4gICAgY29uc3QgbWF0Y2g6IFJlZ0V4cE1hdGNoQXJyYXkgfCBudWxsID0gaW5wdXQubWF0Y2gobnVtYmVyRmlsdGVyKTtcbiAgICBpZiAobWF0Y2ggJiYgbWF0Y2hbMV0pIHtcbiAgICAgIGNvbnN0IGNvbnZlcnRlZDogbnVtYmVyID0gcGFyc2VGbG9hdChtYXRjaFsxXSk7XG4gICAgICByZXR1cm4gIWlzTmFOKGNvbnZlcnRlZCkgPyBjb252ZXJ0ZWQgOiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRSZXBlYXRlckRpZ2l0YWxEYXRhKHJhdzogSVJlcGVhdGVyUmF3KTogSVJlcGVhdGVyRGlnaXRhbE1vZGVzIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgY29udmVydGVkOiBJUmVwZWF0ZXJEaWdpdGFsTW9kZXMgPSB7XG4gICAgLy8gVE9ETzogQVRWPzogYm9vbGVhbjtcbiAgICBETVI6IChyYXcuREdUTC5pbmNsdWRlcygnRCcpIHx8IHJhd1snRE1SIEVuYWJsZWQnXSkgPyB7IENvbG9yQ29kZTogY29udmVydE51bWJlcihyYXdbJ0NvbG9yIENvZGUnXSksIElEOiBjb252ZXJ0TnVtYmVyKHJhd1snRE1SIElEJ10pIH0gOiB1bmRlZmluZWQsXG4gICAgUDI1OiAocmF3LkRHVEwuaW5jbHVkZXMoJ1AnKSB8fCByYXdbJ1AtMjUgRGlnaXRhbCBFbmFibGVkJ10pID8geyBOQUM6IGNvbnZlcnROdW1iZXIocmF3Lk5BQykgfSA6IHVuZGVmaW5lZCxcbiAgICBEU3RhcjogKHJhdy5ER1RMLmluY2x1ZGVzKCdTJykgfHwgcmF3WydELVNUQVIgRW5hYmxlZCddKSA/IHsgTm9kZTogcmF3Lk5vZGUgfSA6IHVuZGVmaW5lZCxcbiAgICBZU0Y6IChyYXcuREdUTC5pbmNsdWRlcygnWScpIHx8IHJhd1snWVNGIERpZ2l0YWwgRW5hYmxlZCddKSA/IHtcbiAgICAgIEdyb3VwSUQ6IHtcbiAgICAgICAgSW5wdXQ6IHR5cGVvZiByYXdbJ0RHLUlEJ10gPT09ICdudW1iZXInID8gcmF3WydERy1JRCddIDogdHlwZW9mIHJhd1snREctSUQnXSA9PT0gJ3N0cmluZycgPyByYXdbJ0RHLUlEJ10uc3BsaXQoJy8nKVswXS50cmltKCkgOiB1bmRlZmluZWQsXG4gICAgICAgIE91dHB1dDogdHlwZW9mIHJhd1snREctSUQnXSA9PT0gJ251bWJlcicgPyByYXdbJ0RHLUlEJ10gOiB0eXBlb2YgcmF3WydERy1JRCddID09PSAnc3RyaW5nJyA/IHJhd1snREctSUQnXS5zcGxpdCgnLycpWzFdLnRyaW0oKSA6IHVuZGVmaW5lZCxcbiAgICAgIH0sXG4gICAgfSA6IHVuZGVmaW5lZCxcbiAgfTtcbiAgaWYgKGNvbnZlcnRlZC5ETVIgfHwgY29udmVydGVkLlAyNSB8fCBjb252ZXJ0ZWQuRFN0YXIgfHwgY29udmVydGVkLllTRikge1xuICAgIHJldHVybiBjb252ZXJ0ZWQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gY29udmVydFJlcGVhdGVyVk9JUChyYXc6IElSZXBlYXRlclJhdyk6IElSZXBlYXRlclZPSVBNb2RlcyB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IGNvbnZlcnRlZDogSVJlcGVhdGVyVk9JUE1vZGVzID0ge1xuICAgIEFsbFN0YXI6IChyYXcuVk9JUC5pbmNsdWRlcygnQScpIHx8IHJhdy5BbGxTdGFyKSA/IHsgTm9kZUlEOiBjb252ZXJ0TnVtYmVyKHJhdy5BbGxTdGFyKSB9IDogdW5kZWZpbmVkLFxuICAgIEVjaG9MaW5rOiAocmF3LlZPSVAuaW5jbHVkZXMoJ0UnKSB8fCByYXcuRWNob0xpbmspID8ge1xuICAgICAgTm9kZUlEOiByYXcuRWNob0xpbmssXG4gICAgfSA6IHVuZGVmaW5lZCwgLy8gVE9ETzogU3RhdHVzPzogRWNob0xpbmtOb2RlU3RhdHVzXG4gICAgSVJMUDogKHJhdy5WT0lQLmluY2x1ZGVzKCdJJykgfHwgcmF3LklSTFApID8geyBOb2RlSUQ6IGNvbnZlcnROdW1iZXIocmF3LklSTFApIH0gOiB1bmRlZmluZWQsXG4gICAgV2lyZXM6IChyYXcuVk9JUC5pbmNsdWRlcygnVycpIHx8IHJhd1snV0lSRVMtWCddKSA/IHsgSUQ6IGNvbnZlcnROdW1iZXIocmF3WydXSVJFUy1YJ10pIH0gOiB1bmRlZmluZWQsXG4gIH07XG4gIGlmIChjb252ZXJ0ZWQuQWxsU3RhciB8fCBjb252ZXJ0ZWQuRWNob0xpbmsgfHwgY29udmVydGVkLklSTFAgfHwgY29udmVydGVkLldpcmVzKSB7XG4gICAgcmV0dXJuIGNvbnZlcnRlZDtcbiAgfVxufVxuIl19