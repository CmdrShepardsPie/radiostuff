"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("module-alias/register");
const fs_helpers_1 = require("@helpers/fs-helpers");
const log_helpers_1 = require("@helpers/log-helpers");
const log = log_helpers_1.createLog("Make Chirp");
const chirp = {
    Location: "",
    Name: "",
    Frequency: "",
    Duplex: "",
    Offset: "",
    Tone: "",
    rToneFreq: "",
    cToneFreq: "",
    DtcsCode: "",
    DtcsRxCode: "",
    DtcsPolarity: "NN",
    Mode: "FM",
    TStep: 5,
    Comment: "",
};
async function doIt(inFileName, outFileName) {
    const fileData = await fs_helpers_1.readFileAsync(inFileName);
    const repeaters = JSON.parse(fileData.toString());
    const mapped = repeaters
        // .filter((r) => r.Call && r.Use === "OPEN" && r["Op Status"] !== "Off-Air")
        .map((d, i) => ({ ...makeRow(d), Location: i }));
    return await fs_helpers_1.writeToJsonAndCsv(outFileName, mapped);
}
function makeRow(item) {
    const DTCS = /D(\d+)/;
    // Doesn't account for multiple digital modes, uses the first one it finds
    let isDigital = Object.keys(item).filter((key) => /Enabled/.test(key)).map((name) => (name.match(/(.*) Enabled/) || [])[1])[0];
    if (isDigital) {
        log("IS DIGITAL", isDigital);
        isDigital = isDigital.replace(" Digital", "");
        switch (isDigital) {
            case "D-STAR":
                isDigital = "DV"; // Documented mapping
                break;
            case "P25": // Literal mapping
            case "DMR": // Literal mapping
                break;
            case "YSF":
                isDigital = "DIG"; // Don't know if YSF = DIG mapping, but don't see any other candidates
                break;
            case "NXDN":
                isDigital = "FSK"; // NXDN uses FSK, so assuming mapping
                break;
        }
        log("IS DIGITAL", isDigital);
    }
    const isNarrow = Object.entries(item).filter((a) => /Narrow/i.test(a[1])).length > 0;
    const Name = 
    // item.Frequency
    //   .toString()
    ((item.Call || "")
        .toLocaleUpperCase()
        .trim()
        .substr(-3))
        + "" +
        ((item.Location || "")
            .toLocaleLowerCase()
            .trim())
            .replace(/\s+/g, "");
    const Frequency = item.Frequency;
    const Duplex = item.Offset > 0 ? "+" : item.Offset < 0 ? "-" : "";
    const Offset = Math.abs(item.Offset);
    const UplinkTone = item["Uplink Tone"] || item.Tone;
    const DownlinkTone = item["Downlink Tone"];
    let cToneFreq = "";
    let rToneFreq = "";
    let DtcsCode = "";
    let DtcsRxCode = "";
    let Tone = "";
    const Mode = isDigital ? isDigital : isNarrow ? "NFM" : "FM";
    const Comment = `${item["ST/PR"] || ""} ${item.County || ""} ${item.Location || ""} ${item.Call || ""} ${item.Sponsor || ""} ${item.Affiliate || ""} ${item.Frequency} ${item.Use || ""} ${item["Op Status"] || ""}`.replace(/\s+/g, " ");
    if (typeof UplinkTone === "number") {
        rToneFreq = UplinkTone;
        cToneFreq = UplinkTone;
        Tone = "Tone";
    }
    else if (UplinkTone !== undefined) {
        const d = DTCS.exec(UplinkTone);
        if (d && d[1]) {
            const n = parseInt(d[1], 10);
            if (!isNaN(n)) {
                DtcsCode = n;
                DtcsRxCode = n;
                Tone = "DTCS";
            }
        }
    }
    if (typeof DownlinkTone === "number") {
        cToneFreq = DownlinkTone;
        // Tone = "TSQL";
    }
    else if (DownlinkTone !== undefined) {
        const d = DTCS.exec(DownlinkTone);
        if (d && d[1]) {
            const n = parseInt(d[1], 10);
            if (!isNaN(n)) {
                DtcsRxCode = n;
                Tone = "DTCS";
            }
        }
    }
    if (rToneFreq !== cToneFreq) {
        // Tone = "Cross";
    }
    cToneFreq = cToneFreq || 88.5;
    rToneFreq = rToneFreq || 88.5;
    DtcsCode = DtcsCode || 23;
    DtcsRxCode = DtcsRxCode || 23;
    // log(chalk.green("Made Row"), row);
    return {
        ...chirp,
        // Location,
        Name,
        Frequency,
        Duplex,
        Offset,
        rToneFreq,
        cToneFreq,
        DtcsCode,
        DtcsRxCode,
        Tone,
        Mode,
        Comment,
    };
}
async function start() {
    // const coFiles = (await readdirAsync("./repeaters/data/CO/")).map((f) => `data/CO/${f}`);
    // const utFiles = (await readdirAsync("./repeaters/data/UT/")).map((f) => `data/UT/${f}`);
    // const nmFiles = (await readdirAsync("./repeaters/data/NM/")).map((f) => `data/NM/${f}`);
    // const coGroups = (await readdirAsync("./repeaters/groups/CO/")).map((f) => `groups/CO/${f}`);
    // const utGroups = (await readdirAsync("./repeaters/groups/UT/")).map((f) => `groups/UT/${f}`);
    // const nmGroups = (await readdirAsync("./repeaters/groups/NM/")).map((f) => `groups/NM/${f}`);
    // const allFiles = [...coFiles, ...utFiles, ...nmFiles, ...coGroups, ...utGroups, ...nmGroups].filter((f) => /\.json$/.test(f)).map((f) => f.replace(".json", ""));
    // for (const file of allFiles) {
    //   await doIt(file);
    // }
    // await doIt("data/repeaters/groups/CO/Colorado Springs - Call.json", "data/repeaters/chirp/groups/CO/Colorado Springs - Call");
    // await doIt("data/repeaters/results/CO/Colorado Springs.json", "data/repeaters/chirp/CO/Colorado Springs");
    await doIt("data/repeaters/combined/CO.json", "data/repeaters/chirp/combined/CO");
    await doIt("data/repeaters/groups/combined/CO - Call.json", "data/repeaters/chirp/groups/CO - Call");
}
exports.default = start();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFrZS1jaGlycC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JpcHRzL21ha2UtY2hpcnAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxpQ0FBK0I7QUFFL0Isb0RBQW1GO0FBQ25GLHNEQUErQztBQUcvQyxNQUFNLEdBQUcsR0FBRyx1QkFBUyxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBb0JwQyxNQUFNLEtBQUssR0FBRztJQUNaLFFBQVEsRUFBRSxFQUFFO0lBQ1osSUFBSSxFQUFFLEVBQUU7SUFDUixTQUFTLEVBQUUsRUFBRTtJQUNiLE1BQU0sRUFBRSxFQUFFO0lBQ1YsTUFBTSxFQUFFLEVBQUU7SUFDVixJQUFJLEVBQUUsRUFBRTtJQUNSLFNBQVMsRUFBRSxFQUFFO0lBQ2IsU0FBUyxFQUFFLEVBQUU7SUFDYixRQUFRLEVBQUUsRUFBRTtJQUNaLFVBQVUsRUFBRSxFQUFFO0lBQ2QsWUFBWSxFQUFFLElBQUk7SUFDbEIsSUFBSSxFQUFFLElBQUk7SUFDVixLQUFLLEVBQUUsQ0FBQztJQUNSLE9BQU8sRUFBRSxFQUFFO0NBQ1osQ0FBQztBQUVGLEtBQUssVUFBVSxJQUFJLENBQUMsVUFBa0IsRUFBRSxXQUFtQjtJQUN6RCxNQUFNLFFBQVEsR0FBRyxNQUFNLDBCQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDakQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLENBQWdCLENBQUM7SUFFakUsTUFBTSxNQUFNLEdBQUcsU0FBUztRQUN4Qiw2RUFBNkU7U0FDMUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFFbkQsT0FBTyxNQUFNLDhCQUFpQixDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMs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QWlJO0lBQ2pJLDZHQUE2RztJQUM3RyxNQUFNLElBQUksQ0FBQyxpQ0FBaUMsRUFBRSxrQ0FBa0MsQ0FBQyxDQUFDO0lBQ2xGLE1BQU0sSUFBSSxDQUFDLCtDQUErQyxFQUFFLHVDQUF1QyxDQUFDLENBQUM7QUFDdkcsQ0FBQztBQUVELGtCQUFlLEtBQUssRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFwibW9kdWxlLWFsaWFzL3JlZ2lzdGVyXCI7XG5cbmltcG9ydCB7cmVhZGRpckFzeW5jLCByZWFkRmlsZUFzeW5jLCB3cml0ZVRvSnNvbkFuZENzdn0gZnJvbSBcIkBoZWxwZXJzL2ZzLWhlbHBlcnNcIjtcbmltcG9ydCB7Y3JlYXRlTG9nfSBmcm9tIFwiQGhlbHBlcnMvbG9nLWhlbHBlcnNcIjtcbmltcG9ydCB7SVJlcGVhdGVyfSBmcm9tIFwiLi9tb2R1bGVzL2kucmVwZWF0ZXJcIjtcblxuY29uc3QgbG9nID0gY3JlYXRlTG9nKFwiTWFrZSBDaGlycFwiKTtcblxuaW50ZXJmYWNlIElDaGlycCB7XG4gIExvY2F0aW9uOiBudW1iZXI7XG4gIE5hbWU6IHN0cmluZztcbiAgRnJlcXVlbmN5OiBudW1iZXI7XG4gIER1cGxleDogc3RyaW5nO1xuICBPZmZzZXQ6IG51bWJlcjtcbiAgVG9uZTogc3RyaW5nO1xuICByVG9uZUZyZXE6IG51bWJlcjtcbiAgY1RvbmVGcmVxOiBudW1iZXI7XG4gIER0Y3NDb2RlOiBudW1iZXI7XG4gIER0Y3NSeENvZGU6IG51bWJlcjtcbiAgRHRjc1BvbGFyaXR5OiBzdHJpbmc7XG4gIE1vZGU6IHN0cmluZztcbiAgVFN0ZXA6IG51bWJlcjtcbiAgQ29tbWVudDogc3RyaW5nO1xuICBbaW5kZXg6IHN0cmluZ106IGFueTtcbn1cblxuY29uc3QgY2hpcnAgPSB7XG4gIExvY2F0aW9uOiBcIlwiLFxuICBOYW1lOiBcIlwiLFxuICBGcmVxdWVuY3k6IFwiXCIsXG4gIER1cGxleDogXCJcIixcbiAgT2Zmc2V0OiBcIlwiLFxuICBUb25lOiBcIlwiLFxuICByVG9uZUZyZXE6IFwiXCIsXG4gIGNUb25lRnJlcTogXCJcIixcbiAgRHRjc0NvZGU6IFwiXCIsXG4gIER0Y3NSeENvZGU6IFwiXCIsXG4gIER0Y3NQb2xhcml0eTogXCJOTlwiLFxuICBNb2RlOiBcIkZNXCIsXG4gIFRTdGVwOiA1LFxuICBDb21tZW50OiBcIlwiLFxufTtcblxuYXN5bmMgZnVuY3Rpb24gZG9JdChpbkZpbGVOYW1lOiBzdHJpbmcsIG91dEZpbGVOYW1lOiBzdHJpbmcpIHtcbiAgY29uc3QgZmlsZURhdGEgPSBhd2FpdCByZWFkRmlsZUFzeW5jKGluRmlsZU5hbWUpO1xuICBjb25zdCByZXBlYXRlcnMgPSBKU09OLnBhcnNlKGZpbGVEYXRhLnRvU3RyaW5nKCkpIGFzIElSZXBlYXRlcltdO1xuXG4gIGNvbnN0IG1hcHBlZCA9IHJlcGVhdGVyc1xuICAvLyAuZmlsdGVyKChyKSA9PiByLkNhbGwgJiYgci5Vc2UgPT09IFwiT1BFTlwiICYmIHJbXCJPcCBTdGF0dXNcIl0gIT09IFwiT2ZmLUFpclwiKVxuICAgIC5tYXAoKGQsIGkpID0+ICh7IC4uLm1ha2VSb3coZCksIExvY2F0aW9uOiBpIH0pKTtcblxuICByZXR1cm4gYXdhaXQgd3JpdGVUb0pzb25BbmRDc3Yob3V0RmlsZU5hbWUsIG1hcHBlZCk7XG59XG5cbmZ1bmN0aW9uIG1ha2VSb3coaXRlbTogSVJlcGVhdGVyKSB7XG4gIGNvbnN0IERUQ1MgPSAvRChcXGQrKS87XG5cbiAgLy8gRG9lc24ndCBhY2NvdW50IGZvciBtdWx0aXBsZSBkaWdpdGFsIG1vZGVzLCB1c2VzIHRoZSBmaXJzdCBvbmUgaXQgZmluZHNcbiAgbGV0IGlzRGlnaXRhbCA9IE9iamVjdC5rZXlzKGl0ZW0pLmZpbHRlcigoa2V5KSA9PiAvRW5hYmxlZC8udGVzdChrZXkpKS5tYXAoKG5hbWUpID0+IChuYW1lLm1hdGNoKC8oLiopIEVuYWJsZWQvKSB8fCBbXSlbMV0pWzBdO1xuICBpZiAoaXNEaWdpdGFsKSB7XG4gICAgbG9nKFwiSVMgRElHSVRBTFwiLCBpc0RpZ2l0YWwpO1xuICAgIGlzRGlnaXRhbCA9IGlzRGlnaXRhbC5yZXBsYWNlKFwiIERpZ2l0YWxcIiwgXCJcIik7XG4gICAgc3dpdGNoIChpc0RpZ2l0YWwpIHtcbiAgICAgIGNhc2UgXCJELVNUQVJcIjpcbiAgICAgICAgaXNEaWdpdGFsID0gXCJEVlwiOyAvLyBEb2N1bWVudGVkIG1hcHBpbmdcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiUDI1XCI6IC8vIExpdGVyYWwgbWFwcGluZ1xuICAgICAgY2FzZSBcIkRNUlwiOiAvLyBMaXRlcmFsIG1hcHBpbmdcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiWVNGXCI6XG4gICAgICAgIGlzRGlnaXRhbCA9IFwiRElHXCI7IC8vIERvbid0IGtub3cgaWYgWVNGID0gRElHIG1hcHBpbmcsIGJ1dCBkb24ndCBzZWUgYW55IG90aGVyIGNhbmRpZGF0ZXNcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiTlhETlwiOlxuICAgICAgICBpc0RpZ2l0YWwgPSBcIkZTS1wiOyAvLyBOWEROIHVzZXMgRlNLLCBzbyBhc3N1bWluZyBtYXBwaW5nXG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgICBsb2coXCJJUyBESUdJVEFMXCIsIGlzRGlnaXRhbCk7XG4gIH1cbiAgY29uc3QgaXNOYXJyb3cgPSBPYmplY3QuZW50cmllcyhpdGVtKS5maWx0ZXIoKGEpID0+IC9OYXJyb3cvaS50ZXN0KGFbMV0gYXMgc3RyaW5nKSkubGVuZ3RoID4gMDtcblxuICBjb25zdCBOYW1lID1cbiAgICAvLyBpdGVtLkZyZXF1ZW5jeVxuICAgIC8vICAgLnRvU3RyaW5nKClcbiAgICAoXG4gICAgICAoaXRlbS5DYWxsIHx8IFwiXCIpXG4gICAgICAgIC50b0xvY2FsZVVwcGVyQ2FzZSgpXG4gICAgICAgIC50cmltKClcbiAgICAgICAgLnN1YnN0cigtMylcbiAgICApXG4gICAgKyBcIlwiICtcbiAgICAoXG4gICAgICAoaXRlbS5Mb2NhdGlvbiB8fCBcIlwiKVxuICAgICAgICAudG9Mb2NhbGVMb3dlckNhc2UoKVxuICAgICAgICAudHJpbSgpXG4gICAgKVxuICAgICAgLnJlcGxhY2UoL1xccysvZywgXCJcIik7XG5cbiAgY29uc3QgRnJlcXVlbmN5ID0gaXRlbS5GcmVxdWVuY3k7XG4gIGNvbnN0IER1cGxleCA9IGl0ZW0uT2Zmc2V0ID4gMCA/IFwiK1wiIDogaXRlbS5PZmZzZXQgPCAwID8gXCItXCIgOiBcIlwiO1xuICBjb25zdCBPZmZzZXQgPSBNYXRoLmFicyhpdGVtLk9mZnNldCk7XG4gIGNvbnN0IFVwbGlua1RvbmUgPSBpdGVtW1wiVXBsaW5rIFRvbmVcIl0gfHwgaXRlbS5Ub25lO1xuICBjb25zdCBEb3dubGlua1RvbmUgPSBpdGVtW1wiRG93bmxpbmsgVG9uZVwiXTtcbiAgbGV0IGNUb25lRnJlcTogYW55ID0gXCJcIjtcbiAgbGV0IHJUb25lRnJlcTogYW55ID0gXCJcIjtcbiAgbGV0IER0Y3NDb2RlOiBhbnkgPSBcIlwiO1xuICBsZXQgRHRjc1J4Q29kZTogYW55ID0gXCJcIjtcbiAgbGV0IFRvbmUgPSBcIlwiO1xuICBjb25zdCBNb2RlID0gaXNEaWdpdGFsID8gaXNEaWdpdGFsIDogaXNOYXJyb3cgPyBcIk5GTVwiIDogXCJGTVwiO1xuICBjb25zdCBDb21tZW50ID0gYCR7aXRlbVtcIlNUL1BSXCJdIHx8IFwiXCJ9ICR7aXRlbS5Db3VudHkgfHwgXCJcIn0gJHtpdGVtLkxvY2F0aW9uIHx8IFwiXCJ9ICR7aXRlbS5DYWxsIHx8IFwiXCJ9ICR7aXRlbS5TcG9uc29yIHx8IFwiXCJ9ICR7aXRlbS5BZmZpbGlhdGUgfHwgXCJcIn0gJHtpdGVtLkZyZXF1ZW5jeX0gJHtpdGVtLlVzZSB8fCBcIlwifSAke2l0ZW1bXCJPcCBTdGF0dXNcIl0gfHwgXCJcIn1gLnJlcGxhY2UoL1xccysvZywgXCIgXCIpO1xuXG4gIGlmICh0eXBlb2YgVXBsaW5rVG9uZSA9PT0gXCJudW1iZXJcIikge1xuICAgIHJUb25lRnJlcSA9IFVwbGlua1RvbmU7XG4gICAgY1RvbmVGcmVxID0gVXBsaW5rVG9uZTtcbiAgICBUb25lID0gXCJUb25lXCI7XG4gIH0gZWxzZSBpZiAoVXBsaW5rVG9uZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgY29uc3QgZCA9IERUQ1MuZXhlYyhVcGxpbmtUb25lKTtcbiAgICBpZiAoZCAmJiBkWzFdKSB7XG4gICAgICBjb25zdCBuID0gcGFyc2VJbnQoZFsxXSwgMTApO1xuICAgICAgaWYgKCFpc05hTihuKSkge1xuICAgICAgICBEdGNzQ29kZSA9IG47XG4gICAgICAgIER0Y3NSeENvZGUgPSBuO1xuICAgICAgICBUb25lID0gXCJEVENTXCI7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKHR5cGVvZiBEb3dubGlua1RvbmUgPT09IFwibnVtYmVyXCIpIHtcbiAgICBjVG9uZUZyZXEgPSBEb3dubGlua1RvbmU7XG4gICAgLy8gVG9uZSA9IFwiVFNRTFwiO1xuICB9IGVsc2UgaWYgKERvd25saW5rVG9uZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgY29uc3QgZCA9IERUQ1MuZXhlYyhEb3dubGlua1RvbmUpO1xuICAgIGlmIChkICYmIGRbMV0pIHtcbiAgICAgIGNvbnN0IG4gPSBwYXJzZUludChkWzFdLCAxMCk7XG4gICAgICBpZiAoIWlzTmFOKG4pKSB7XG4gICAgICAgIER0Y3NSeENvZGUgPSBuO1xuICAgICAgICBUb25lID0gXCJEVENTXCI7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKHJUb25lRnJlcSAhPT0gY1RvbmVGcmVxKSB7XG4gICAgLy8gVG9uZSA9IFwiQ3Jvc3NcIjtcbiAgfVxuXG4gIGNUb25lRnJlcSA9IGNUb25lRnJlcSB8fCA4OC41O1xuICByVG9uZUZyZXEgPSByVG9uZUZyZXEgfHwgODguNTtcbiAgRHRjc0NvZGUgPSBEdGNzQ29kZSB8fCAyMztcbiAgRHRjc1J4Q29kZSA9IER0Y3NSeENvZGUgfHwgMjM7XG5cbiAgLy8gbG9nKGNoYWxrLmdyZWVuKFwiTWFkZSBSb3dcIiksIHJvdyk7XG4gIHJldHVybiB7XG4gICAgLi4uY2hpcnAgYXMgYW55LFxuICAgIC8vIExvY2F0aW9uLFxuICAgIE5hbWUsXG4gICAgRnJlcXVlbmN5LFxuICAgIER1cGxleCxcbiAgICBPZmZzZXQsXG4gICAgclRvbmVGcmVxLFxuICAgIGNUb25lRnJlcSxcbiAgICBEdGNzQ29kZSxcbiAgICBEdGNzUnhDb2RlLFxuICAgIFRvbmUsXG4gICAgTW9kZSxcbiAgICBDb21tZW50LFxuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydCgpIHtcbiAgLy8gY29uc3QgY29GaWxlcyA9IChhd2FpdCByZWFkZGlyQXN5bmMoXCIuL3JlcGVhdGVycy9kYXRhL0NPL1wiKSkubWFwKChmKSA9PiBgZGF0YS9DTy8ke2Z9YCk7XG4gIC8vIGNvbnN0IHV0RmlsZXMgPSAoYXdhaXQgcmVhZGRpckFzeW5jKFwiLi9yZXBlYXRlcnMvZGF0YS9VVC9cIikpLm1hcCgoZikgPT4gYGRhdGEvVVQvJHtmfWApO1xuICAvLyBjb25zdCBubUZpbGVzID0gKGF3YWl0IHJlYWRkaXJBc3luYyhcIi4vcmVwZWF0ZXJzL2RhdGEvTk0vXCIpKS5tYXAoKGYpID0+IGBkYXRhL05NLyR7Zn1gKTtcbiAgLy8gY29uc3QgY29Hcm91cHMgPSAoYXdhaXQgcmVhZGRpckFzeW5jKFwiLi9yZXBlYXRlcnMvZ3JvdXBzL0NPL1wiKSkubWFwKChmKSA9PiBgZ3JvdXBzL0NPLyR7Zn1gKTtcbiAgLy8gY29uc3QgdXRHcm91cHMgPSAoYXdhaXQgcmVhZGRpckFzeW5jKFwiLi9yZXBlYXRlcnMvZ3JvdXBzL1VUL1wiKSkubWFwKChmKSA9PiBgZ3JvdXBzL1VULyR7Zn1gKTtcbiAgLy8gY29uc3Qgbm1Hcm91cHMgPSAoYXdhaXQgcmVhZGRpckFzeW5jKFwiLi9yZXBlYXRlcnMvZ3JvdXBzL05NL1wiKSkubWFwKChmKSA9PiBgZ3JvdXBzL05NLyR7Zn1gKTtcbiAgLy8gY29uc3QgYWxsRmlsZXMgPSBbLi4uY29GaWxlcywgLi4udXRGaWxlcywgLi4ubm1GaWxlcywgLi4uY29Hcm91cHMsIC4uLnV0R3JvdXBzLCAuLi5ubUdyb3Vwc10uZmlsdGVyKChmKSA9PiAvXFwuanNvbiQvLnRlc3QoZikpLm1hcCgoZikgPT4gZi5yZXBsYWNlKFwiLmpzb25cIiwgXCJcIikpO1xuICAvLyBmb3IgKGNvbnN0IGZpbGUgb2YgYWxsRmlsZXMpIHtcbiAgLy8gICBhd2FpdCBkb0l0KGZpbGUpO1xuICAvLyB9XG5cbiAgLy8gYXdhaXQgZG9JdChcImRhdGEvcmVwZWF0ZXJzL2dyb3Vwcy9DTy9Db2xvcmFkbyBTcHJpbmdzIC0gQ2FsbC5qc29uXCIsIFwiZGF0YS9yZXBlYXRlcnMvY2hpcnAvZ3JvdXBzL0NPL0NvbG9yYWRvIFNwcmluZ3MgLSBDYWxsXCIpO1xuICAvLyBhd2FpdCBkb0l0KFwiZGF0YS9yZXBlYXRlcnMvcmVzdWx0cy9DTy9Db2xvcmFkbyBTcHJpbmdzLmpzb25cIiwgXCJkYXRhL3JlcGVhdGVycy9jaGlycC9DTy9Db2xvcmFkbyBTcHJpbmdzXCIpO1xuICBhd2FpdCBkb0l0KFwiZGF0YS9yZXBlYXRlcnMvY29tYmluZWQvQ08uanNvblwiLCBcImRhdGEvcmVwZWF0ZXJzL2NoaXJwL2NvbWJpbmVkL0NPXCIpO1xuICBhd2FpdCBkb0l0KFwiZGF0YS9yZXBlYXRlcnMvZ3JvdXBzL2NvbWJpbmVkL0NPIC0gQ2FsbC5qc29uXCIsIFwiZGF0YS9yZXBlYXRlcnMvY2hpcnAvZ3JvdXBzL0NPIC0gQ2FsbFwiKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgc3RhcnQoKTtcbiJdfQ==